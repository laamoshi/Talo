<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Laam wallet</title>
    <!-- Favicon & OG Image -->
    <link rel="icon" type="image/png" href="https://i.ibb.co/r28SP1bN/20250802-225108.png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/r28SP1bN/20250802-225108.png">
    <meta property="og:image" content="https://i.ibb.co/r28SP1bN/20250802-225108.png">
    <meta property="og:title" content="Laam wallet - Modern Digital Currency">
    <meta property="og:description" content="Laam Token is a digital asset built on Stellar with a fixed supply.">
    <meta property="og:url" content="https://laam.online">
    <meta property="og:type" content="website">
<!-- Android PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1976d2">

<!-- iPhone / iPad PWA -->
<link rel="apple-touch-icon" href="https://i.ibb.co/r28SP1bN/20250802-225108.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Laam Wallet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/10.4.0/stellar-sdk.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<!-- Add Chart.js for beautiful charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
 /* Fingerprint Sensor Styles */
  .fingerprint-section {
    margin: 25px 0;
    padding: 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .fingerprint-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 15px;
  }
  
  .fingerprint-btn:hover {
    background: linear-gradient(135deg, #059669, #047857);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
  }
  
  .fingerprint-btn:disabled {
    background: #6b7280;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  
  .fingerprint-icon {
    font-size: 20px;
  }
  
  .biometric-options {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }
  
  .biometric-option {
    flex: 1;
    padding: 12px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    color: var(--text);
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    font-size: 14px;
  }
  
  .biometric-option:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--brand);
  }
  
  .biometric-option.active {
    background: rgba(124, 58, 237, 0.2);
    border-color: var(--brand);
  }
  
  .setup-fingerprint-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #7c3aed, #6d28d9);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 10px;
  }
  
  .setup-fingerprint-btn:hover {
    background: linear-gradient(135deg, #6d28d9, #5b21b6);
    transform: translateY(-2px);
  }
  
  .fingerprint-status {
    text-align: center;
    margin: 15px 0;
    padding: 12px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
  }
  
  .fingerprint-status.enabled {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.3);
  }
  
  .fingerprint-status.disabled {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.3);
  }
  
  .fingerprint-scanner {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  
  .fingerprint-scanner.active {
    display: flex;
  }
  
  .scanner-container {
    background: var(--card);
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    border: 1px solid var(--line);
    max-width: 400px;
    width: 90%;
  }
  
  .scanner-animation {
    width: 120px;
    height: 120px;
    border: 3px solid var(--brand);
    border-radius: 50%;
    position: relative;
    margin: 0 auto 30px;
    animation: pulse 2s infinite;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .scanner-animation::before {
    content: 'üñêÔ∏è';
    font-size: 40px;
    position: absolute;
  }
  
  .scanner-animation.scanning::before {
    content: 'üëá';
    animation: fingerprintScan 1.5s infinite;
  }
  
  @keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
  }
  
  @keyframes fingerprintScan {
    0% { transform: translateY(0); }
    50% { transform: translateY(10px); }
    100% { transform: translateY(0); }
  }
  
  .scanner-text {
    color: white;
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 10px;
  }
  
  .scanner-subtext {
    color: var(--muted);
    font-size: 14px;
    margin-bottom: 30px;
  }
  
  .cancel-scan {
    background: rgba(239, 68, 68, 0.8);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  
  .cancel-scan:hover {
    background: rgba(239, 68, 68, 1);
  }
  
  .device-support-info {
    margin-top: 15px;
    font-size: 12px;
    color: var(--muted);
    text-align: center;
  }
  
  .supported-devices {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-top: 15px;
  }
  
  .device-item {
    padding: 8px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    font-size: 12px;
    text-align: center;
  }
  :root{
    /* Modern Purple & Dark Theme */
    --bg1: #0f0f23;
    --bg2: #1a1a2e;
    --card: rgba(26, 26, 46, 0.8);
    --text: #f0f0f0;
    --muted: #a0a0c0;
    --brand: #7c3aed;
    --brand2: #6d28d9;
    --line: rgba(255, 255, 255, 0.1);
    --ok: #10b981;
    --warn: #f59e0b;
    --err: #ef4444;
    --maxw: 920px;
    --rad: 20px;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: var(--text);
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px 14px;
    position: relative;
    overflow-x: hidden;
  }
  
  body::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      radial-gradient(circle at 10% 20%, rgba(124, 58, 237, 0.1) 0%, transparent 20%),
      radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 20%),
      radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.05) 0%, transparent 50%);
    z-index: -1;
  }
  
  .app {
    width: 100%;
    max-width: 450px;
    text-align: center;
    position: relative;
    z-index: 1;
  }
  
  /* Logo and Header Styles */
  .logo-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 40px;
    position: relative;
  }
  
  .logo-container::after {
    content: "";
    position: absolute;
    bottom: -15px;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--brand), transparent);
    border-radius: 3px;
  }
  
  .logo-container img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    box-shadow: 0 8px 25px rgba(124, 58, 237, 0.3);
    transition: transform 0.3s ease;
  }
  
  .logo-container img:hover {
    transform: scale(1.05);
  }
  
  h1 {
    margin: 0;
    font-size: 3rem;
    font-weight: 800;
    background: linear-gradient(135deg, #7c3aed, #10b981);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 2px 10px rgba(124, 58, 237, 0.3);
  }
  
  /* Import Card Styles */
  .import-card {
    background: rgba(26, 26, 46, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--rad);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
    padding: 40px 30px;
    margin: 0 auto;
    max-width: 100%;
    position: relative;
    overflow: hidden;
  }
  
  .import-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--brand), var(--ok));
  }
  
  .form-group {
    margin-bottom: 24px;
    text-align: left;
  }
  
  .form-label {
    display: block;
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 10px;
    padding-left: 5px;
  }
  
  .form-input {
    width: 100%;
    padding: 16px 18px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    font-size: 16px;
    background: rgba(15, 15, 35, 0.7);
    color: var(--text);
    outline: none;
    transition: all 0.3s ease;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
  }
  
  .form-input:focus {
    border-color: var(--brand);
    background: rgba(15, 15, 35, 0.9);
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
  }
  
  .form-input::placeholder {
    color: var(--muted);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }
  
  .import-button {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--brand), var(--brand2));
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
    margin-top: 16px;
    position: relative;
    overflow: hidden;
  }
  
  .import-button::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
  }
  
  .import-button:hover::before {
    left: 100%;
  }
  
  .import-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(124, 58, 237, 0.5);
  }
  
  .divider {
    margin: 32px 0;
    text-align: center;
    position: relative;
  }
  
  .divider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: rgba(255, 255, 255, 0.1);
  }
  
  .divider-text {
    background: var(--card);
    padding: 0 16px;
    color: var(--muted);
    font-size: 14px;
    font-weight: 500;
  }
  
  .generate-link {
    text-align: center;
  }
  
  .generate-button {
    color: var(--brand);
    text-decoration: none;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: color 0.3s ease;
    text-transform: none;
    padding: 0;
    width: auto;
    box-shadow: none;
  }
  
  .generate-button:hover {
    color: var(--brand2);
  }
  
  .note-text {
    font-size: 12px;
    color: var(--muted);
    margin-top: 8px;
    line-height: 1.4;
  }

  /* Key Display Modal */
  .key-modal {
    display: none;
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  
  .key-modal.show {
    display: flex;
  }
  
  .key-modal-content {
    background: var(--card);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--rad);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    padding: 40px 30px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    backdrop-filter: blur(10px);
    position: relative;
  }
  
  .key-modal-content::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--brand), var(--ok));
    border-radius: var(--rad) var(--rad) 0 0;
  }
  
  .key-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
  }
  
  .key-modal-title {
    font-size: 1.8rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--brand), var(--ok));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin: 0;
  }
  
  .key-modal-close {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: var(--muted);
    padding: 5px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }
  
  .key-modal-close:hover {
    color: var(--text);
    background: rgba(255, 255, 255, 0.2);
  }
  
  .key-display-group {
    margin-bottom: 30px;
  }
  
  .key-display-label {
    display: block;
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 12px;
  }
  
  .key-display-container {
    position: relative;
    display: flex;
    align-items: center;
  }
  
  .key-display-input {
    width: 100%;
    padding: 15px 60px 15px 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    font-size: 14px;
    background: rgba(15, 15, 35, 0.7);
    color: var(--text);
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    word-break: break-all;
    resize: none;
  }
  
  .copy-btn {
    position: absolute;
    right: 10px;
    background: var(--brand);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
  }
  
  .copy-btn:hover {
    background: var(--brand2);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
    transform: translateY(-1px);
  }
  
  .copy-btn.copied {
    background: var(--ok);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
  }
  
  .warning-text {
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 12px;
    padding: 15px;
    margin: 20px 0;
    color: var(--warn);
    font-size: 14px;
    line-height: 1.5;
  }
  
  .use-account-btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, var(--ok), #059669);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
    position: relative;
    overflow: hidden;
  }
  
  .use-account-btn::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
  }
  
  .use-account-btn:hover::before {
    left: 100%;
  }
  
  .use-account-btn:hover {
    background: linear-gradient(135deg, #059669, #047857);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    transform: translateY(-2px);
  }
  /* Main Card Styles */
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:var(--rad);
    box-shadow:0 10px 30px rgba(0,0,0,0.1); padding:22px; margin:14px auto;
  }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  @media (max-width:820px){ .grid-2{ grid-template-columns:1fr; } }
  label{ display:block; text-align:left; margin:8px 0 6px; font-weight:600; color:var(--brand); }
  input,select,button{
    width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:12px; font-size:1rem;
    background:#f8f9fa; color:var(--text); outline:none; transition:border-color .2s ease;
  }
  input:focus{ border-color:var(--brand); }
  button{
    background:var(--brand); color:#fff; font-weight:700; letter-spacing:.02em; border:none;
    box-shadow:0 4px 14px rgba(0,82,204,0.3); cursor:pointer; text-transform:uppercase; transition:all .2s ease;
  }
  button:hover{ background:var(--brand2); box-shadow:0 6px 18px rgba(0,65,163,0.4); transform:translateY(-2px); }
  button:disabled{ background:#b0bec5; cursor:not-allowed; box-shadow:none; transform:none; }
  .btn-secondary{ background:#6c757d; color:#fff; box-shadow:0 4px 14px rgba(0,0,0,0.1); }
  .btn-secondary:hover{ background:#5a6268; }
  .btn-danger{ background:var(--err); color:#fff; box-shadow:0 4px 14px rgba(220,53,69,0.3); }
  .btn-danger:hover{ background:#c82333; }
  .mono{
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
    background:#e9ecef; padding:10px 12px; border-radius:12px; overflow-wrap:anywhere; color:#343a40;
  }
  .muted{ color:var(--muted); font-size:.92rem; }
  .balances{ display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
  .pill{ background:#e9ecef; border:1px solid var(--line); padding:8px 14px; border-radius:999px; font-weight:600; }
  .hidden{ display:none; }
  .send-wrap{ display:none; margin-top:16px; text-align:left; border-top:1px solid var(--line); padding-top:16px; }
  .send-row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  @media (max-width:640px){ .send-row{ grid-template-columns:1fr; } }

  /* Trade Section Styles */
   .trade-card {
    padding: 0;
    overflow: hidden;
    position: relative;
  }
  
  .trade-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--brand), var(--ok));
    border-radius: var(--rad) var(--rad) 0 0;
  }
  
  .trade-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--line);
    width: 100%;
  }
.left-icons, .right-icons {
  display: flex;
  align-items: center;
}

.trade-header h3 {
  margin: 0;
}
  .trade-asset-selector{ display:flex; align-items:center; justify-content:space-between; padding:16px 20px; background: black; }
  .asset-box{ display:flex; align-items:center; gap:8px; }
  .asset-box img{ width:24px; height:24px; border-radius:50%; }
  .asset-box .asset-name{ font-weight:600; }
  .asset-box .asset-issuer{ font-size:.8rem; color:var(--muted); }
  .swap-icon{ font-size:1.5rem; background: black; border-radius:50%; padding:5px; border:1px solid var(--line); cursor:pointer; transition:all 0.3s ease; }
  .swap-icon:hover{ background:var(--brand); color: black; transform:rotate(180deg); }
  .trade-tabs{ display:flex; border-bottom:1px solid var(--line); background: black; }
  .trade-tabs .tab{ 
    flex:1; padding:12px; text-align:center; cursor:pointer; font-weight:600; 
    color:var(--muted); border-bottom:3px solid transparent; 
    transition:all 0.3s ease; position:relative;
  }
  .trade-tabs .tab:hover{ background:rgba(0,82,204,0.1); color:var(--brand); }
  .trade-tabs .tab.active{ color:var(--brand); border-bottom-color:var(--brand); background: black; }
  .tab-content{ display:none; }
  .tab-content.active{ display:block; }
  .overview-content{ padding:20px; text-align:center; }
  .price-display {
  font-size: 2.5rem;
  font-weight: bold;
  margin-bottom: 10px;
  color: white; /* qoraalka weyn madow */
}

.price-change {
  font-size: 1rem;
  margin-bottom: 20px;
  color: black; /* qoraalka madow */
}

.price-change.positive {
  color: white; /* halkii cagaar */
}

.price-change.negative {
  color: white; /* halkii cas */
}

.chart-timeframes {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
}

.timeframe-btn { 
  padding: 8px 15px;
  border-radius: 8px;
  border: 1px solid var(--line);
  background: white;
  color: black; /* qoraalka madow */
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
  font-weight: 600;
}

.timeframe-btn:hover,
.timeframe-btn.active {
  background: var(--brand);
  color: black; /* qoraalka madow xitaa marka la doorto */
  border-color: var(--brand);
}

.chart-container {
  width: 100%; 
  height: 200px; 
  margin-bottom: 20px;
  position: relative;
}
  .market-stats{ display:grid; grid-template-columns:1fr 1fr; gap:15px; text-align:left; }
  .stat-item{ background: black; padding:12px; border-radius:8px; border:1px solid var(--line); }
  .stat-label{ font-size:0.8rem; color:var(--muted); margin-bottom:4px; }
  .stat-value{ font-weight:600; color:var(--text); }
  .orderbook-content{ padding:10px 20px 20px; }
  .orderbook-table{ width:100%; border-collapse:collapse; margin-bottom:10px; }
  .orderbook-table th,.orderbook-table td{ text-align:right; padding:8px 4px; font-size:.9rem; }
  .orderbook-table th{ color:var(--muted); font-weight:600; border-bottom:2px solid var(--line); }
  .orderbook-table th:first-child,.orderbook-table td:first-child{ text-align:left; }
  .orderbook-table .bid-row{ cursor:pointer; transition:background 0.2s ease; }
  .orderbook-table .bid-row:hover{ background:rgba(40,167,69,0.1); }
  .orderbook-table .bid-row td:nth-child(2){ color:var(--ok); font-weight:600; }
  .orderbook-table .ask-row{ cursor:pointer; transition:background 0.2s ease; }
  .orderbook-table .ask-row:hover{ background:rgba(220,53,69,0.1); }
  .orderbook-table .ask-row td:nth-child(2){ color:var(--err); font-weight:600; }
  .spread{ 
    padding:12px 0; text-align:center; font-weight:bold; 
    border-top:1px solid var(--line); border-bottom:1px solid var(--line); 
    margin:8px 0; background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%); border-radius:8px;
  }
  .trades-content{ padding:10px 20px 20px; }
  .trades-table{ width:100%; border-collapse:collapse; }
  .trades-table th,.trades-table td{ text-align:right; padding:8px 4px; font-size:.9rem; }
  .trades-table th{ color:var(--muted); font-weight:600; border-bottom:2px solid var(--line); }
  .trades-table th:first-child,.trades-table td:first-child{ text-align:left; }
  .trade-buy{ color:var(--ok); }
  .trade-sell{ color:var(--err); }
  .trade-time{ color:var(--muted); font-size:0.8rem; }
  .trade-actions{ display:flex; gap:15px; padding:20px; background:#f8f9fa; border-top:1px solid var(--line); }
  .trade-actions button{ 
    flex:1; padding:16px; font-size:1.1rem; border-radius:12px; text-transform:uppercase; 
    font-weight:700; transition:all 0.3s ease; position:relative; overflow:hidden;
  }
  .trade-actions button:before{
    content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition:left 0.5s; z-index:1;
  }
  .trade-actions button:before{
    content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition:left 0.5s; z-index:1;
  }
  .trade-actions button:hover:before{ left:100%; }
  .btn-buy{ background:var(--ok); box-shadow:0 4px 14px rgba(40,167,69,0.3); }
  .btn-buy:hover{ background:#218838; box-shadow:0 6px 20px rgba(40,167,69,0.4); transform:translateY(-2px); }
  .btn-sell{ background:var(--err); color:#fff; box-shadow:0 4px 14px rgba(220,53,69,0.3); }
  .btn-sell:hover{ background:#c82333; box-shadow:0 6px 20px rgba(220,53,69,0.4); transform:translateY(-2px); }
  .loading-spinner{ 
    display:inline-block; width:20px; height:20px; 
    border:3px solid #f3f3f3; border-top:3px solid var(--brand); 
    border-radius:50%; animation:spin 1s linear infinite; 
  }
  @keyframes spin{ 0%{ transform:rotate(0deg); } 100%{ transform:rotate(360deg); } }

  /* Modal Styles */
  .trade-modal{ display:none; position:fixed; inset:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; }
  .trade-modal.show{ display:flex; }
  .modal-content{ 
    background:var(--card); border:1px solid var(--line); border-radius:var(--rad); 
    box-shadow:0 20px 40px rgba(0,0,0,0.15); padding:20px; max-width:420px; width:90%; 
    max-height:90vh; overflow-y:auto; animation:modalSlideIn 0.3s ease-out;
  }
  @keyframes modalSlideIn{ from{ opacity:0; transform:translateY(-50px); } to{ opacity:1; transform:translateY(0); } }
  .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
  .modal-title{ font-size:1.5rem; font-weight:700; color:var(--brand); margin:0; }
  .modal-close{ 
    background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--muted); 
    padding:5px; width:auto; height:auto; box-shadow:none; text-transform:none; 
    border-radius:50%; transition:all 0.3s ease;
  }
  .modal-close:hover{ color:var(--text); background:rgba(0,0,0,0.1); transform:none; box-shadow:none; }
  .panel{ background:#f8f9fa; border:1px solid var(--line); border-radius:12px; padding:20px; margin:0; }
  .titleRow{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
  .title{ font-size:1.2rem; font-weight:700; color:var(--brand); }
  .avail{ font-size:.9rem; color:var(--muted); }
  .field{ margin-bottom:16px; }
  .inputWrap{ position:relative; display:flex; align-items:center; }
  .inputWrap input{ padding-right:60px; margin:0; border:2px solid var(--line); transition:border-color 0.3s ease; }
  .inputWrap input:focus{ border-color:var(--brand); box-shadow:0 0 0 3px rgba(0,82,204,0.1); }
  .unit{ position:absolute; right:12px; color:var(--muted); font-weight:600; pointer-events:none; }
  .hint{ font-size:.8rem; color:var(--muted); margin-top:4px; text-align:left; }
  .rowBtns{ display:flex; gap:8px; margin-top:8px; }
  .rowBtns button{ 
    flex:1; padding:8px 12px; font-size:.7rem; background: Green; color:var(--text); 
    border:1px solid var(--line); text-transform:none; font-weight:600; border-radius:6px;
    transition:all 0.3s ease;
  }
  .rowBtns button:hover{ background:var(--brand); color: black; transform:translateY(-1px); }
  .totalBox{ margin-bottom:20px; }
  .totalBox input{ background: black; color:var(--muted); }
  .cta{ 
    padding:16px; font-size:1.1rem; font-weight:700; text-transform:uppercase; margin:0; 
    border-radius:12px; transition:all 0.3s ease; position:relative; overflow:hidden;
  }
  .cta:before{
    content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition:left 0.5s; z-index:1;
  }
  .cta:hover:before{ left:100%; }
  .cta.buy{ background:var(--ok); box-shadow:0 4px 14px rgba(40,167,69,0.3); }
  .cta.buy:hover{ background:#218838; box-shadow:0 6px 20px rgba(40,167,69,0.4); transform:translateY(-2px); }
  .cta.sell{ background:var(--err); color: black; box-shadow:0 4px 14px rgba(220,53,69,0.3); }
  .cta.sell:hover{ background:#c82333; box-shadow:0 6px 20px rgba(220,53,69,0.4); transform:translateY(-2px); }
/* Fix for Buy/Sell Laam buttons and input text visibility */
.btn-buy { 
    background: linear-gradient(135deg, #10b981, #059669) !important; 
    color: white !important;
    box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3) !important;
    border: none !important;
}

.btn-buy:hover { 
    background: linear-gradient(135deg, #059669, #047857) !important;
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4) !important; 
    transform: translateY(-2px) !important;
}

.btn-sell { 
    background: linear-gradient(135deg, #ef4444, #dc2626) !important; 
    color: white !important;
    box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3) !important;
    border: none !important;
}

.btn-sell:hover { 
    background: linear-gradient(135deg, #dc2626, #b91c1c) !important;
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4) !important; 
    transform: translateY(-2px) !important;
}

/* Fix input text visibility in trade modal */
.trade-modal input {
    background: white !important;
    color: #333 !important;
    border: 1px solid #ddd !important;
}

.trade-modal input:focus {
    border-color: var(--brand) !important;
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2) !important;
}

.trade-modal .unit {
    color: #666 !important;
}

.trade-modal .totalBox input {
    background: #f8f9fa !important;
    color: #333 !important;
    border: 1px solid #ddd !important;
}

.trade-modal .hint {
    color: #666 !important;
}

.trade-modal .avail {
    color: #666 !important;
}

   /* My Orders Modal Styles */
  .my-orders-modal {
    display: none;
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  
  .my-orders-modal.show {
    display: flex;
  }
  
  .my-orders-modal-content {
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--rad);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    padding: 30px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  }
  
  .my-orders-modal-content::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--brand), var(--ok));
    border-radius: var(--rad) var(--rad) 0 0;
  }
  
  .my-orders-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
  }
  
  .my-orders-modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--brand), var(--ok));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin: 0;
  }
  
  .my-orders-modal-close {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    font-size: 1.8rem;
    cursor: pointer;
    color: var(--muted);
    padding: 5px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }
  
  .my-orders-modal-close:hover {
    color: var(--text);
    background: rgba(255, 255, 255, 0.2);
  }
  
  .orders-list {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 20px;
  }
  
  .order-item {
    display: flex;
    justify-content: space-between;
    padding: 12px;
    border: 1px solid var(--line);
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: rgba(15, 15, 35, 0.7);
  }
  
  .order-item:hover {
    background-color: rgba(124, 58, 237, 0.1);
  }
  
  .order-item.selected {
    border-color: var(--brand);
    background-color: rgba(124, 58, 237, 0.2);
  }
  
  .order-type {
    font-weight: 700;
    text-transform: uppercase;
    font-size: 12px;
  }
  
  .order-type.buy {
    color: var(--ok);
  }
  
  .order-type.sell {
    color: var(--err);
  }
  
  .order-amount, .order-price {
    font-family: 'SF Mono', monospace;
  }
  
  .order-actions {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  .order-action-btn {
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: none;
    position: relative;
    overflow: hidden;
  }
  
  .order-action-btn::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
  }
  
  .order-action-btn:hover::before {
    left: 100%;
  }
  
  .edit-order-btn {
    background: var(--brand);
    color: white;
    box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
  }
  
  .edit-order-btn:hover {
    background: var(--brand2);
    box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
    transform: translateY(-2px);
  }
  
  .cancel-order-btn {
    background: var(--err);
    color: white;
    box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
  }
  
  .cancel-order-btn:hover {
    background: #dc2626;
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    transform: translateY(-2px);
  }
/* Fix for Edit Order Modal Inputs */
#editOrderModal input {
    background: white !important;
    color: #333 !important;
    border: 1px solid #ddd !important;
}

#editOrderModal input:focus {
    border-color: var(--brand) !important;
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2) !important;
}

#editOrderModal .panel {
    background: #f8f9fa !important;
}

#editOrderModal label {
    color: #333 !important;
}

  /* Animation */
  .import-card {
    animation: slideUp 0.6s ease-out;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 480px) {
    .app {
      max-width: 100%;
      padding: 0 10px;
    }
    
    .import-card {
      padding: 30px 20px;
      margin: 10px;
    }
    
    .logo-container img {
      width: 60px;
      height: 60px;
    }
    
    h1 {
      font-size: 2.2rem;
    }

    .key-modal-content {
      padding: 30px 20px;
      margin: 10px;
    }

    .key-display-input {
      font-size: 12px;
      padding: 12px 50px 12px 12px;
    }

    .copy-btn {
      padding: 6px 8px;
      font-size: 10px;
    }

    .market-stats {
      grid-template-columns: 1fr;
    }

    .chart-timeframes {
      flex-wrap: wrap;
    }
  }

  /* New UI Elements for the Wallet */
.wallet-container {
    background: white;
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  
.total-assets {
  background: linear-gradient(135deg, #2196f3, #21cbf3);
  color: white;
  border-radius: 20px;
  padding: 20px 30px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
  text-align: center;
  max-width: 250px;
  margin: 20px auto;
  transition: transform 0.3s, box-shadow 0.3s;
}

.total-assets:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
}

.total-label {
  font-size: 14px;
  font-weight: 500;
  opacity: 0.9;
}

.total-value {
  font-size: 36px;
  font-weight: bold;
  margin-top: 8px;
  letter-spacing: 1px;
}

.action-buttons {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            julstify-content: center;
            padding: 15px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
            cursor: pointer;
            border: 1px solid #eee;
        }
        
        .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
        }
        
        .action-button.send {
            background: linear-gradient(135deg, #1976d2, #2196f3);
            color: white;
        }
        
        .action-button.receive {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        
        .action-button.trustline {
            background: linear-gradient(135deg, #fd7e14, #ffc107);
            color: white;
        }
        
        .action-button.lock {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            color: white;
            
        }
        
        .action-icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }
        
        .action-text {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .footer {
            padding: 20px;
            text-align: center;
            color: #777;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }
        
        .highlight {
            color: #2196f3;
            font-weight: 600;
        }
        

  /* Send Button */
  .send-btn {
    background: #1976d2;
    color: white;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s;
  }
  .send-btn:hover {
    background: #1565c0;
  }

    /* Overlay */
wizardOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

/* Modal wrap */
.send-wrap {
  background: linear-gradient(45deg, #FFD700, #FFDF00, #FFC700);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 20px;
  max-width: 420px;
  width: 90%;
  color: #fff;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  position: relative;
  animation: fadeIn .3s ease;
}

/* Close button */
#sendWizard  {
  position: absolute;
  top: 12px;
  right: 12px;
  background: Silver;
  border: none;
  font-size: 22px;
  color: #fff;
  cursor: pointer;
}

/* Steps */
#sendWizard h3 {
  margin-bottom: 15px;
  font-size: 20px;
  font-weight: 600;
}

#sendWizard input, 
#sendWizard select {
  width: 100%;
  padding: 10px 12px;
  margin: 10px 0;
  border-radius: 10px;
  border: none;
  outline: none;
  background: rgba(255,255,255,0.1);
  color: #fff;
}
#confirmDest {
  display: inline-block;
  word-break: break-all;   /* jebin xaraf kasta haddii uu dhaafo */
  overflow-wrap: anywhere; /* taageero dheeraad ah */
  max-width: 100%;         /* ha ka bixin box-kiisa */
}
/* Button group */
.btn-group {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  margin-top: 15px;
}

.wizard-btn {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.wizard-btn.primary {
  background: #007aff;
  color: #fff;
}
.wizard-btn.primary:hover {
  background: #005fcc;
}

.wizard-btn.secondary {
  background: rgba(255,255,255,0.15);
  color: #fff;
}
.wizard-btn.secondary:hover {
  background: rgba(255,255,255,0.25);
}

.wizard-btn.confirm {
  background: #4cd964;
  color: #fff;
}
.wizard-btn.confirm:hover {
  background: #38b64c;
}
/* Animation */
@keyframes fadeIn {
  from {opacity: 0; transform: translateY(20px);}
  to {opacity: 1; transform: translateY(0);}
    }

        @media (max-width: 480px) {
            .header {
                padding: 20px;
            }    

.assets-grid {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.asset-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #111827;
  border-radius: 12px;
  padding: 12px 16px;
  color: #fff;
}

.asset-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.asset-icon img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
}

.asset-details .asset-name {
  font-weight: bold;
  font-size: 14px;
}

.asset-details .asset-price {
  font-size: 12px;
  color: #9ca3af;
}

.price-change.positive { color: #22c55e; }
.price-change.negative { color: #ef4444; }

.asset-right {
  text-align: right;
}

.asset-balance {
  font-size: 14px;
  font-weight: bold;
}

.asset-balance-sub {
  font-size: 12px;
  color: #9ca3af;
}
        
     /* Token Modal Styles */
  .token-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }

  .token-modal.show {
    display: flex;
  }

  .token-modal-content {
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    width: 85%;
    max-width: 400px;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    animation: modalAppear 0.3s ease-out;
  }

  @keyframes modalAppear {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .token-modal-header {
    padding: 20px;
    text-align: center;
    background: rgba(0, 0, 0, 0.2);
  }

  .token-modal-header h2 {
    font-size: 22px;
    margin-bottom: 5px;
    color: white;
  }

  .token-modal-body {
    padding: 25px;
  }

  .token-info {
    display: flex;
    align-items: center;
    margin-bottom: 25px;
  }

  .token-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
  }

  .token-icon img {
    width: 70%;
    height: 70%;
    object-fit: contain;
  }

  .token-details h3 {
    font-size: 24px;
    margin-bottom: 5px;
    color: white;
  }

  .token-details p {
    color: #a0a0a0;
  }

  .token-modal-actions {
    display: flex;
    gap: 15px;
  }

  .token-modal-btn {
    flex: 1;
    padding: 16px 0;
    border-radius: 12px;
    border: none;
    font-weight: 600;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    color: white;
  }

  .token-modal-btn i {
    font-size: 24px;
    margin-bottom: 8px;
  }

  .token-modal-btn.send {
    background: #e74c3c;
  }

  .token-modal-btn.receive {
    background: #2ecc71;
  }

  .token-modal-btn:active {
    transform: scale(0.95);
  }

  .close-token-modal {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.1);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  .close-token-modal i {
    font-size: 24px;
    color: white;
  }
  
  /* Hover effect for asset items */
  .asset-item {
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .asset-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
  }
  .custom-alert {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #28a745;
    color: black;
    padding: 14px 22px;
    border-radius: 12px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    z-index: 9999;
    display: none;
    animation: fadeInUp 0.4s ease;
  }
  
  @keyframes fadeInUp {
    from { opacity: 0; transform: translate(-50%, 20px); }
    to { opacity: 1; transform: translate(-50%, 0); }
  }

/* ==== Custom Dark Wallet Design (Mockup Style) ==== */
.wallet-container {
  background: rgba(0, 0, 0, 0.85);
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.6);
  margin-bottom: 20px;
}
.total-assets {
  padding: 15px 20px;
  border-radius: 12px;
  color: white;
  font-weight: 600;
  font-family: sans-serif;
  text-align: center;

  /* Gradient background: black */
  background: linear-gradient(135deg, #000000, );
  
  /* Shadow for depth */
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.total-assets .total-label {
  font-size: 14px;
  margin-bottom: 6px;
}

.total-assets .total-value {
  font-size: 20px;
}

.assets-grid {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.asset-item {
  background: rgba(255,255,255,0.05);
  border-radius: 16px;
  padding: 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
.asset-name {
  font-weight: 600;
  font-size: 16px;
  color: #fff;
}
.asset-price {
  font-size: 13px;
  color: #aaa;
}

.action-button {
  flex: 1;
  padding: 14px;
  border-radius: 14px;
  text-align: center;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(0,0,0,0.4);
  color: #fff;
}
.action-button.send {
  background: linear-gradient(135deg, #ff416c, #ff4b2b);
}
.action-button.receive {
  background: linear-gradient(135deg, #11998e, #38ef7d);
}
.action-button.trustline {
  background: linear-gradient(135deg, #f7971e, #ffd200);
  color: #000;
}
.action-button.lock {
  background: linear-gradient(135deg, #283c86, #45a247);
}


/* ==== Background Gradient ==== */
body::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      radial-gradient(circle at 10% 20%, rgba(124, 58, 237, 0.1) 0%, transparent 20%),
      radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 20%),
      radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.05) 0%, transparent 50%);
    z-index: -1;
  }

@keyframes gradientShift {
  0% {background-position: 0% 50%;}
  50% {background-position: 100% 50%;}
  100% {background-position: 0% 50%;}
}

/* ==== Smaller Action Buttons ==== */
.action-buttons {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-top: 20px;
}
.action-button {
  padding: 10px;
  border-radius: 12px;
  font-size: 0.9rem;
  font-weight: 600;
}

</style>
</head>
<body>
  <div class="app">
    <div class="logo-container">
      <img src="https://i.ibb.co/r28SP1bN/20250802-225108.png" alt="Laam Logo">
      <h1>Laam wallet</h1>
    </div>

    <!-- AUTH SECTION -->
    <div id="authSection">
      <div class="import-card">
        <div id="unlockView" class="hidden">
          <h3 style="margin:0 0 20px 0; color:#1976d2; text-align:center; font-size:1.5rem;">Unlock Wallet</h3>
          <div class="form-group">
            <label class="form-label" for="walletPassword">Password</label>
            <input class="form-input" id="walletPassword" type="password" placeholder="Enter your password" />
          </div>
          <button class="import-button" id="unlockBtn">Unlock</button>
          
          <!-- Real Fingerprint Unlock Section -->
          <div class="fingerprint-section" id="fingerprintSection" style="display: none;">
            <div class="divider">
              <span class="divider-text">or unlock with</span>
            </div>
            
            <button class="fingerprint-btn" id="fingerprintUnlockBtn">
              <span class="fingerprint-icon">üñêÔ∏è</span>
              Fingerprint Unlock
            </button>
            
            <div id="fingerprintStatus" class="fingerprint-status disabled">
              Fingerprint unlock not set up
            </div>
            
            <button class="setup-fingerprint-btn" id="setupFingerprintBtn">
              Set Up Fingerprint Unlock
            </button>
            
            <div class="device-support-info">
              Supported: Touch ID, Face ID, Windows Hello, Android Biometric
            </div>
          </div>
          
          <div class="divider">
            <span class="divider-text">or</span>
          </div>
          <div class="generate-link">
            <a href="#" id="resetWalletLink" style="color:#1976d2; text-decoration:none;">Reset and Import New Key</a>
          </div>
        </div>

        <div id="initialView">
          <div class="form-group">
            <label class="form-label" for="secretKeyInput">Secret Key (S...)</label>
            <input class="form-input" id="secretKeyInput" type="password" placeholder="SXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"/>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="savePasswordInput">Create Password to Save</label>
            <input class="form-input" id="savePasswordInput" type="password" placeholder="Min 8 chars"/>
          </div>
          
          <button class="import-button" id="importAndSaveBtn">Import wallet and Save</button>
          
          <div class="divider">
            <span class="divider-text">or</span>
          </div>
          
          <div class="generate-link">
            <button class="generate-button" id="generateAccountBtn">Create new wallet</button>
            <p class="note-text">(Remember: You must deposit at least 4 XLM into your wallet for it to be activated.)</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Real Fingerprint Scanner -->
    <div id="fingerprintScanner" class="fingerprint-scanner">
      <div class="scanner-container">
        <div class="scanner-animation" id="scannerAnimation">
          <!-- Fingerprint icon will be inserted here -->
        </div>
        <div class="scanner-text" id="scannerText">Ready for Fingerprint</div>
        <div class="scanner-subtext" id="scannerSubtext">Place your finger on the sensor</div>
        <button class="cancel-scan" id="cancelScan">Cancel</button>
        
        <div class="supported-devices">
          <div class="device-item">Touch ID</div>
          <div class="device-item">Face ID</div>
          <div class="device-item">Windows Hello</div>
          <div class="device-item">Android</div>
        </div>
      </div>
    </div>

    <!-- Key Display Modal -->
    <div id="keyModal" class="key-modal">
      <div class="key-modal-content">
        <div class="key-modal-header">
          <h3 class="key-modal-title">New Wallet Account Generated</h3>
          <button class="key-modal-close" onclick="closeKeyModal()">&times;</button>
        </div>
        
        <div class="key-display-group">
          <label class="key-display-label">Secret Key (S...)</label>
          <div class="key-display-container">
            <textarea class="key-display-input" id="generatedSecretKey" readonly rows="3"></textarea>
            <button class="copy-btn" onclick="copyToClipboard('generatedSecretKey', this)">Copy</button>
          </div>
        </div>

        <div class="key-display-group">
          <label class="key-display-label">Public Key (G...)</label>
          <div class="key-display-container">
            <textarea class="key-display-input" id="generatedPublicKey" readonly rows="2"></textarea>
            <button class="copy-btn" onclick="copyToClipboard('generatedPublicKey', this)">Copy</button>
          </div>
        </div>

        <div class="warning-text">
          <strong>‚ö†Ô∏èIMPORTANT</strong> Save your Secret Key in a secure place! You will need it to access your wallet. If you lose it, you will not be able to recover your account. Also, copy your public key and fund it with at least 4 XLM to activate your wallet.
        </div>

        <button class="use-account-btn" onclick="useGeneratedAccount()">Use This Account</button>
      </div>
    </div>

    <!-- LOGGED IN VIEW -->
    <div id="loggedInView" class="hidden">
      <!-- Wallet Container with New Design -->
      <div class="wallet-container">
        <!-- Total Assets -->
<div class="total-assets">
   Total Assets: $<span id="totalAssets">0.00</span>
</div>

<!-- Wizard Overlay -->
<div id="wizardOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;"></div>

<!-- Send Wizard Modal -->
<div id="sendWizard" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:black; padding:20px; border-radius:12px; z-index:1000; width:320px; max-width:90%; color:white;">
  <h3>Send Asset</h3>

  <!-- Error Box -->
  <div id="wizardError" style="display:none; color:#ff3b30; font-weight:600; margin-bottom:10px; text-align:center;">
    Please fill in all required fields
  </div>

  <!-- Step 1: Choose Asset -->
  <div id="step1" class="wizard-step">
    <label for="sendAsset">Asset <span style="color:red">*</span></label>
    <select id="sendAsset" style="width:100%; margin-bottom:10px;">
      <option value="">--Choose--</option>
      <option value="XLM">XLM</option>
      <option value="LAAM">LAAM</option>
      <option value="USDC">USDC</option>
    </select>
    <div class="btn-group" style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="nextStep(2)" style="flex:1;">Next</button>
    </div>
  </div>

  <!-- Step 2: Enter Amount -->
  <div id="step2" class="wizard-step" style="display:none;">
    <label for="sendAmount">Amount <span style="color:red">*</span></label>
    <input type="number" id="sendAmount" placeholder="0.0" style="width:100%; margin-bottom:10px;">
    <div class="btn-group" style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="nextStep(3)" style="flex:1;">Next</button>
    </div>
  </div>

  <!-- Step 3: Enter Address or Scan -->
  <div id="step3" class="wizard-step" style="display:none;">
    <label for="sendDest">Destination Address <span style="color:red">*</span></label>
    <input type="text" id="sendDest" placeholder="Enter Stellar address" style="width:100%; margin-bottom:10px;">
    <button type="button" id="scanQRBtn" style="width:100%; margin-bottom:10px;">Scan QR</button>
    <div id="qr-reader" style="width:100%; display:none; margin-bottom:10px;"></div>
    <div class="btn-group" style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="nextStep(4)" style="flex:1;">Next</button>
    </div>
  </div>

  <!-- Step 4: Memo (Optional) -->
  <div id="step4" class="wizard-step" style="display:none;">
    <label for="sendMemo">Memo (Optional)</label>
    <input type="text" id="sendMemo" placeholder="Memo text" style="width:100%; margin-bottom:10px;">
    <div class="btn-group" style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="nextStep(5)" style="flex:1;">Next</button>
    </div>
  </div>

  <!-- Step 5: Confirm -->
  <div id="step5" class="wizard-step" style="display:none;">
    <h4>Confirm Transaction</h4>
    <p>Asset: <span id="confirmAsset"></span></p>
    <p>Amount: <span id="confirmAmount"></span></p>
    <p>Destination: <span id="confirmDest" style="display:inline-block; word-break:break-all; max-width:100%;"></span></p>
    <p>Memo: <span id="confirmMemo"></span></p>
    <div class="btn-group" style="display:flex; gap:10px; margin-top:20px;">
      <button id="confirmSendBtn" onclick="sendTransaction()" style="flex:1;">Send Now</button>
    </div>
  </div>
<!-- Step 6: Enhanced Receipt -->
<div id="step6" class="wizard-step" style="display:none; text-align:left;">
  <div style="background:white; padding:20px; border-radius:16px; color:black; box-shadow:0 6px 15px rgba(0,0,0,0.15); font-family:sans-serif;">
    <h4 style="text-align:center; margin-bottom:15px; color:#333;">Transaction Sent!</h4>

    <p style="margin:8px 0; word-break:break-word;">
      <strong>Destination:</strong> <span id="receiptDest"></span>
      <button onclick="copyToClipboard('receiptDest')" title="Copy" style="margin-left:5px; padding:4px 6px; font-size:12px; border:none; border-radius:6px; background:#f0f0f0; color:#333; cursor:pointer;">
        üìã
      </button>
    </p>

    <p style="margin:8px 0; word-break:break-all;">
      <strong>Txid / Hash:</strong> 
      <a id="receiptHash" href="#" target="_blank" style="color:#1a73e8; text-decoration:underline;"></a>
      <button onclick="copyToClipboard('receiptHash')" title="Copy" style="margin-left:5px; padding:4px 6px; font-size:12px; border:none; border-radius:6px; background:#f0f0f0; color:#333; cursor:pointer;">
        üìã
      </button>
    </p>

    <p style="margin:8px 0;"><strong>Amount:</strong> <span id="receiptAmount"></span></p>
    <p style="margin:8px 0;"><strong>Date:</strong> <span id="receiptDate"></span></p>

    <div style="text-align:center; margin-top:20px;">
      <button onclick="closeWizard()" style="padding:10px 20px; font-size:14px; border:none; border-radius:12px; background:#1a73e8; color:white; font-weight:600; cursor:pointer;">Close</button>
    </div>
  </div>
</div>
 </div>
</div>

    <!-- Action Buttons -->
        <div class="action-buttons">
          <div class="action-button send" id="btnSend">
            <div class="action-icon">‚û§</div>
            <div class="action-text">Send</div>
          </div>
          <div class="action-button receive" id="btnReceive">
            <div class="action-icon">üì•</div>
            <div class="action-text">Receive</div>
          </div>
          <div class="action-button trustline" id="addTrustlineBtn">
            <div class="action-icon">+</div>
            <div class="action-text">Add Trustline</div>
          </div>
          <div class="action-button lock" id="logoutBtn">
            <div class="action-icon">üîí</div>
            <div class="action-text">Lock</div>
          </div>
        </div>
        
        <!-- Assets Grid -->
        <div class="assets-grid">
          <!-- XLM -->
          <div class="asset-item" data-token="XLM">
              <div class="asset-left">
                  <div class="asset-icon">
                      <img src="https://res.coinpaper.com/coinpaper/stellar_xlm_logo_07021d63c0.png" alt="XLM">
                  </div>
                  <div class="asset-details">
                      <div class="asset-name">XLM</div>
                      <div class="asset-price">
                          <small class="per">$<span id="xlmPrice">0.409</span></small>
                          <span id="xlmChange" class="price-change positive">+2.5%</span>
                      </div>
                  </div>
              </div>
              <div class="asset-right">
                  <div class="asset-balance"><span id="xlmBal">0</span> XLM</div>
                  <div class="asset-balance-sub">‚âà $<span id="xlmBalUsd">0</span></div>
              </div>
          </div>

          <!-- LAAM -->
          <div class="asset-item" data-token="LAAM">
              <div class="asset-left">
                  <div class="asset-icon">
                      <img src="https://i.ibb.co/r28SP1bN/20250802-225108.png" alt="LAAM">
                  </div>
                  <div class="asset-details">
                      <div class="asset-name">Laam</div>
                      <div class="asset-price">
                          <small class="per">$<span id="laamPrice">0.056</span></small>
                          <span id="laamChange" class="price-change negative">-1.2%</span>
                      </div>
                  </div>
              </div>
              <div class="asset-right">
                  <div class="asset-balance"><span id="laamBal">0</span> Laam</div>
                  <div class="asset-balance-sub">‚âà $<span id="laamBalUsd">0</span></div>
              </div>
          </div>

          <!-- USDC -->
          <div class="asset-item" data-token="USDC">
              <div class="asset-left">
                  <div class="asset-icon">
                      <img src="https://i.ibb.co/r2qNFs22/images-2.png" alt="USDC">
                  </div>
                  <div class="asset-details">
                      <div class="asset-name">USDC</div>
                      <div class="asset-price">
                          <small class="per">$<span id="usdcPrice">1.00</span></small>
                          <span id="usdcChange" class="price-change">0.00%</span>
                      </div>
                  </div>
              </div>
              <div class="asset-right">
                  <div class="asset-balance"><span id="usdcBal">0</span> USDC</div>
                  <div class="asset-balance-sub">‚âà $<span id="usdcBalUsd">0</span></div>
              </div>
          </div>
        </div>
      
      <!-- Token Modal -->
      <div class="token-modal" id="tokenModal">
        <div class="token-modal-content">
          <div class="token-modal-header">
            <h2 id="modalTokenName">XLM</h2>
            <p>Select an action</p>
          </div>
          <div class="token-modal-body">
            <div class="token-info">
              <div class="token-icon">
                <img id="modalTokenIcon" src="https://res.coinpaper.com/coinpaper/stellar_xlm_logo_07021d63c0.png" alt="Token">
              </div>
              <div class="token-details">
                <h3 id="modalTokenBalance">0 XLM</h3>
                <p id="modalTokenValue">$0.00</p>
              </div>
            </div>
            <div class="token-modal-actions">
              <button class="token-modal-btn send" onclick="openSendWizardForToken()">
                <i>‚û§</i>
                <span>Send</span>
              </button>
              <button class="token-modal-btn receive" onclick="openReceiveForToken()">
                <i>üì•</i>
                <span>Receive</span>
              </button>
            </div>
          </div>
        </div>
        <div class="close-token-modal" onclick="closeTokenModal()">
          <i>‚úï</i>
        </div>
      </div>
                        
      <!-- Enhanced Trade Section -->
      <div class="card trade-card">
     <div class="trade-header">
<span class="icon" id="refreshOB" onclick="fetchOrderbook()">‚Üª</span>
  <h3>Trade</h3>
  <span class="icon" id="myOrdersBtn" onclick="openMyOrdersModal()">offers</span>
</div>
        <div class="trade-asset-selector">
          <div class="asset-box">
            <img src="https://i.ibb.co/r28SP1bN/20250802-225108.png" alt="Laam">
            <div>
              <div class="asset-name">Laam</div>
              <div class="asset-issuer">laam.online</div>
            </div>
          </div>
          <span class="swap-icon" id="swapAssets" onclick="swapTradeAssets()">‚áÑ</span>
          <div class="asset-box">
            <img src="https://res.coinpaper.com/coinpaper/stellar_xlm_logo_07021d63c0.png" alt="XLM">
            <div>
              <div class="asset-name">XLM</div>
              <div class="asset-issuer">stellar.org</div>
            </div>
          </div>
        </div>
        
        <!-- Enhanced Trade Tabs -->
        <div class="trade-tabs">
          <div class="tab" id="overviewTab">Overview</div>
          <div class="tab active" id="orderbookTab">Orderbook</div>
          <div class="tab" id="lastTradesTab">Last Trades</div>
        </div>
        
        <!-- Overview Tab Content -->
        <div id="overviewContent" class="tab-content">
          <div class="overview-content">
            <div class="price-display">
              <span id="overviewLaamPriceXLM">0.000000</span>$
            </div>
            <div class="price-change" id="priceChange">Loading price change...</div>
            
            <div class="chart-timeframes">
              <button class="timeframe-btn active" data-timeframe="1D">1D</button>
              <button class="timeframe-btn" data-timeframe="1W">1W</button>
              <button class="timeframe-btn" data-timeframe="1M">1M</button>
              <button class="timeframe-btn" data-timeframe="ALL">ALL</button>
            </div>
            
            <!-- Chart container for Chart.js -->
            <div class="chart-container">
              <canvas id="priceChart"></canvas>
            </div>
            
            <div class="market-stats">
              <div class="stat-item">
                <div class="stat-label">24h Volume</div>
                <div class="stat-value" id="volume24h">0 Laam</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">24h High</div>
                <div class="stat-value" id="high24h">0.000000 XLM</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">24h Low</div>
                <div class="stat-value" id="low24h">0.000000 XLM</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Market Cap</div>
                <div class="stat-value" id="marketCap">0 XLM</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Orderbook Tab Content -->
        <div id="orderbookContent" class="tab-content active">
          <div class="orderbook-content">
            <table class="orderbook-table">
              <thead><tr><th>Amount (Laam)</th><th>Price (XLM)</th><th>Total (XLM)</th></tr></thead>
              <tbody id="asksBody">
                <tr><td colspan="3" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading...</td></tr>
              </tbody>
            </table>
            <div class="spread" id="spreadValue">Loading spread...</div>
            <table class="orderbook-table">
              <tbody id="bidsBody">
                <tr><td colspan="3" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Last Trades Tab Content -->
        <div id="lastTradesContent" class="tab-content">
          <div class="trades-content">
            <table class="trades-table">
              <thead><tr><th>Time</th><th>Type</th><th>Price (XLM)</th><th>Amount (Laam)</th></tr></thead>
              <tbody id="tradesBody">
                <tr><td colspan="4" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="trade-actions">
          <button class="btn-buy" id="btnBuy">Buy</button>
          <button class="btn-sell" id="btnSell">Sell</button>
        </div>

    <!-- Trade Modal -->
    <div id="tradeModal" class="trade-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="modalTitle">Buy Laam</h3>
          <button class="modal-close" onclick="closeTradeModal()">&times;</button>
        </div>
        <div class="panel">
          <div class="titleRow">
            <div class="title" id="panelTitle">Buy Laam</div>
            <div class="avail">Available: <span id="availBalance">0 XLM</span></div>
          </div>

          <div class="field">
            <div class="inputWrap">
              <input id="modalPrice" type="number" step="0.0000001" placeholder="0.135000" />
              <div class="unit">XLM</div>
            </div>
            <div class="hint">Price (XLM per Laam)</div>
          </div>

          <div class="field">
            <div class="inputWrap">
              <input id="modalAmount" type="number" step="0.0000001" placeholder="Amount" />
              <div class="unit">Laam</div>
            </div>
            <div class="rowBtns">
              <button data-fill="25">25%</button>
              <button data-fill="50">50%</button>
              <button data-fill="75">75%</button>
              <button data-fill="100">100%</button>
            </div>
          </div>

          <div class="totalBox">
            <div class="inputWrap">
              <input id="modalTotal" type="number" step="0.0000001" placeholder="Total" readonly />
              <div class="unit">XLM</div>
            </div>
            <div class="hint">Total cost</div>
          </div>

          <button class="cta buy" id="modalBuyBtn">Buy Laam</button>
        </div>
      </div>
    </div>

    <!-- My Orders Modal -->
    <div id="myOrdersModal" class="my-orders-modal">
      <div class="my-orders-modal-content">
        <div class="my-orders-modal-header">
          <h3 class="my-orders-modal-title">My Orders</h3>
          <button class="my-orders-modal-close" onclick="closeMyOrdersModal()">&times;</button>
        </div>
        
        <div id="ordersList" class="orders-list">
          <div class="loading-spinner"></div>
        </div>
        
        <div class="order-actions">
          <button class="order-action-btn edit-order-btn" onclick="promptEditOffer()">Edit Order</button>
          <button class="order-action-btn cancel-order-btn" onclick="confirmCancelOffer()">Cancel Order</button>
        </div>
      </div>
    </div>

    <!-- Edit Order Modal -->
    <div id="editOrderModal" class="trade-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Edit Order</h3>
          <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="panel">
          <div class="field">
            <label>Amount (Laam)</label>
            <input id="editAmount" type="number" step="0.0001">
          </div>
          <div class="field">
            <label>Price (XLM per Laam)</label>
            <input id="editPrice" type="number" step="0.0000001">
          </div>
          <button class="cta" id="confirmEditBtn">Update Order</button>
        </div>
      </div>
    </div>
    <div id="errorAlert" class="custom-alert" style="background:#dc3545;">Error here</div>
    <div id="successAlert" class="custom-alert">Transaction sent successfully</div>
  </div>

  <script>
    // Laam token configuration
    const LAAM_TOKEN = {
      code: "Laam",
      issuer: "GAL4ECDAXNBMJYFCWIJ32HKVIRLCNEXY664CAZYI3EINQWPLXTMEPR64",
      name: "Laam",
      description: "Laam is a limited supply token on Stellar with a maximum of 1,335,577 tokens, issued only once to preserve value.",
      image: "https://i.ibb.co/r28SP1bN/20250802-225108.png",
      maxSupply: 1335577,
      currentPrice: 0.06
    };

    // USDC token configuration
    const USDC_TOKEN = {
      code: "USDC",
      issuer: "GA5ZSEJYB37JRC5AVCIA5MOP4RHTM335X2KGX3IHOJAPP5RE34K4KZVN"
    };
    
    // Global variables
    let currentKeypair = null;
    let server = null;
    let USDC_ASSET = null;
    let LAAM_ASSET = null;
    let xlmPriceUSD = 0.42;
    let currentTradeMode = 'buy';
    let generatedKeypair = null;
    let currentTab = 'orderbook';
    let orderbookData = { bids: [], asks: [] };
    let tradesData = [];
    let currentOfferId = null;
    let priceChart = null; // Chart.js instance

// Real Fingerprint Authentication using WebAuthn API
    class FingerprintAuth {
      constructor() {
        this.isSupported = false;
        this.isSetup = false;
        this.credentialId = null;
        this.publicKey = null;
        this.init();
      }

      async init() {
        // Check if WebAuthn is supported
        this.isSupported = await this.checkWebAuthnSupport();
        this.loadStoredCredentials();
        this.updateUI();
      }

      async checkWebAuthnSupport() {
        if (!window.PublicKeyCredential) {
          console.log('WebAuthn not supported');
          return false;
        }

        try {
          // Check if platform authenticator is available
          const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
          if (!available) {
            console.log('Platform authenticator not available');
            return false;
          }

          // Check if conditional mediation is supported (for autofill)
          if (PublicKeyCredential.isConditionalMediationAvailable) {
            const conditionalSupported = await PublicKeyCredential.isConditionalMediationAvailable();
            console.log('Conditional mediation supported:', conditionalSupported);
          }

          return true;
        } catch (error) {
          console.error('WebAuthn check failed:', error);
          return false;
        }
      }

      loadStoredCredentials() {
        const storedCredential = localStorage.getItem('laam_webauthn_credential');
        if (storedCredential) {
          try {
            const credential = JSON.parse(storedCredential);
            this.credentialId = credential.id;
            this.publicKey = credential.publicKey;
            this.isSetup = true;
            console.log('Loaded stored WebAuthn credential');
          } catch (error) {
            console.error('Failed to load stored credential:', error);
          }
        }
      }

      updateUI() {
        const fingerprintSection = document.getElementById('fingerprintSection');
        const statusElement = document.getElementById('fingerprintStatus');
        const setupBtn = document.getElementById('setupFingerprintBtn');
        const unlockBtn = document.getElementById('fingerprintUnlockBtn');

        if (!this.isSupported) {
          fingerprintSection.style.display = 'none';
          return;
        }

        fingerprintSection.style.display = 'block';

        if (this.isSetup) {
          statusElement.textContent = 'Fingerprint unlock enabled';
          statusElement.className = 'fingerprint-status enabled';
          unlockBtn.disabled = false;
          setupBtn.textContent = 'Reconfigure Fingerprint';
        } else {
          statusElement.textContent = 'Fingerprint unlock not set up';
          statusElement.className = 'fingerprint-status disabled';
          unlockBtn.disabled = true;
          setupBtn.textContent = 'Set Up Fingerprint Unlock';
        }
      }

      async register() {
        if (!this.isSupported) {
          throw new Error('Fingerprint authentication not supported on this device');
        }

        try {
          // Generate a challenge (in production, this should come from your server)
          const challenge = new Uint8Array(32);
          crypto.getRandomValues(challenge);

          const publicKeyCredentialCreationOptions = {
            challenge: challenge,
            rp: {
              name: "Laam Wallet",
              id: window.location.hostname || "localhost"
            },
            user: {
              id: new Uint8Array(16),
              name: "user@laam.wallet",
              displayName: "Laam Wallet User"
            },
            pubKeyCredParams: [
              {
                alg: -7, // ES256
                type: "public-key"
              }
            ],
            authenticatorSelection: {
              authenticatorAttachment: "platform", // Platform authenticator (fingerprint/face)
              userVerification: "required"
            },
            timeout: 60000,
            attestation: "direct"
          };

          this.showScanner('Register your fingerprint...', 'Follow your device prompts to register');

          const credential = await navigator.credentials.create({
            publicKey: publicKeyCredentialCreationOptions
          });

          this.hideScanner();

          // Store the credential
          const credentialData = {
            id: this.arrayBufferToBase64(credential.rawId),
            publicKey: this.arrayBufferToBase64(credential.response.getPublicKey()),
            type: credential.type
          };

          localStorage.setItem('laam_webauthn_credential', JSON.stringify(credentialData));
          this.credentialId = credentialData.id;
          this.publicKey = credentialData.publicKey;
          this.isSetup = true;

          this.updateUI();
          showSuccess('Fingerprint registered successfully!');

          return credential;

        } catch (error) {
          this.hideScanner();
          console.error('Registration failed:', error);
          
          if (error.name === 'NotAllowedError') {
            throw new Error('Registration cancelled by user or timeout');
          } else if (error.name === 'InvalidStateError') {
            throw new Error('This device is already registered');
          } else {
            throw new Error('Failed to register fingerprint: ' + error.message);
          }
        }
      }

      // Bedel qaybta authenticate function
async authenticate() {
  if (!this.isSupported || !this.isSetup) {
    throw new Error('Fingerprint authentication not set up');
  }

  try {
    const challenge = new Uint8Array(32);
    crypto.getRandomValues(challenge);

    const publicKeyCredentialRequestOptions = {
      challenge: challenge,
      allowCredentials: [{
        id: this.base64ToArrayBuffer(this.credentialId),
        type: "public-key"
      }],
      userVerification: "required",
      timeout: 60000
    };

    this.showScanner('Verify your identity', 'Use your fingerprint to unlock', true);

    const assertion = await navigator.credentials.get({
      publicKey: publicKeyCredentialRequestOptions,
      mediation: 'optional'
    });

    this.hideScanner();

    // ‚úÖ TUSAALE: Fududeynta verification (production-ka waxaad u baahan tahay server verification)
    const isValid = await this.verifyAssertion(assertion);
    
    if (isValid) {
      showSuccess('Fingerprint verified successfully!');
      
      // ‚úÖ HALKAN: Diree unlock wallet-ka marka authentication guulaysato
      try {
        await unlockWalletWithBiometric();
        return true;
      } catch (unlockError) {
        console.error('Unlock failed after auth:', unlockError);
        throw new Error('Wallet unlock failed: ' + unlockError.message);
      }
    } else {
      throw new Error('Fingerprint verification failed');
    }

  } catch (error) {
    this.hideScanner();
    console.error('Authentication failed:', error);
    
    if (error.name === 'NotAllowedError') {
      throw new Error('Authentication cancelled by user or timeout');
    } else {
      throw new Error('Fingerprint authentication failed: ' + error.message);
    }
  }
}
      async verifyAssertion(assertion) {
        // In a real implementation, you would send the assertion to your server for verification
        // For this demo, we'll do basic client-side verification
        
        try {
          // Check if we have a valid signature
          const response = assertion.response;
          if (response && response.signature) {
            return true;
          }
          return false;
        } catch (error) {
          console.error('Assertion verification error:', error);
          return false;
        }
      }

      showScanner(title, subtitle, scanning = false) {
        const scanner = document.getElementById('fingerprintScanner');
        const scannerText = document.getElementById('scannerText');
        const scannerSubtext = document.getElementById('scannerSubtext');
        const scannerAnimation = document.getElementById('scannerAnimation');

        scannerText.textContent = title;
        scannerSubtext.textContent = subtitle;
        
        if (scanning) {
          scannerAnimation.classList.add('scanning');
        } else {
          scannerAnimation.classList.remove('scanning');
        }
        
        scanner.classList.add('active');
      }

      hideScanner() {
        const scanner = document.getElementById('fingerprintScanner');
        const scannerAnimation = document.getElementById('scannerAnimation');
        
        scanner.classList.remove('active');
        scannerAnimation.classList.remove('scanning');
      }

      reset() {
        localStorage.removeItem('laam_webauthn_credential');
        this.credentialId = null;
        this.publicKey = null;
        this.isSetup = false;
        this.updateUI();
      }

      // Utility methods
      arrayBufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
      }

      base64ToArrayBuffer(base64) {
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
      }
    }

    // Initialize fingerprint authentication
    const fingerprintAuth = new FingerprintAuth();

    // Event Listeners for Fingerprint Functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Setup fingerprint button
      document.getElementById('setupFingerprintBtn').addEventListener('click', async function() {
        this.disabled = true;
        this.textContent = 'Setting up...';
        
        try {
          await fingerprintAuth.register();
        } catch (error) {
          showError(error.message);
        } finally {
          this.disabled = false;
          this.textContent = fingerprintAuth.isSetup ? 'Reconfigure Fingerprint' : 'Set Up Fingerprint Unlock';
        }
      });

      // Event listener-ka fingerprint button ku bedel
document.getElementById('fingerprintUnlockBtn').addEventListener('click', async function() {
  this.disabled = true;
  this.textContent = 'Authenticating...';
  
  try {
    await fingerprintAuth.authenticate();
    // HADDA authentication-ku wuxuu isku xiraa unlockWalletWithBiometric()
    console.log('Fingerprint authentication completed');
  } catch (error) {
    console.error('Fingerprint auth error:', error);
    showError(error.message);
    
    // Reset button
    this.disabled = false;
    this.textContent = 'Fingerprint Unlock';
  }
});

      // Cancel scan button
      document.getElementById('cancelScan').addEventListener('click', function() {
        fingerprintAuth.hideScanner();
      });

      // Auto-fill fingerprint on page load (if supported)
      if (fingerprintAuth.isSupported && fingerprintAuth.isSetup) {
        setTimeout(() => {
          tryAutoFill();
        }, 1000);
      }
    });

    // Auto-fill functionality
    async function tryAutoFill() {
      if (!fingerprintAuth.isSupported || !fingerprintAuth.isSetup) return;

      try {
        const challenge = new Uint8Array(32);
        crypto.getRandomValues(challenge);

        const publicKeyCredentialRequestOptions = {
          challenge: challenge,
          allowCredentials: [{
            id: fingerprintAuth.base64ToArrayBuffer(fingerprintAuth.credentialId),
            type: "public-key"
          }],
          userVerification: "required",
          timeout: 30000 // Shorter timeout for auto-fill
        };

        const assertion = await navigator.credentials.get({
          publicKey: publicKeyCredentialRequestOptions,
          mediation: 'conditional' // This enables auto-fill
        });

        if (assertion) {
          const isValid = await fingerprintAuth.verifyAssertion(assertion);
          if (isValid) {
            showSuccess('Auto-unlocked with fingerprint!');
            await unlockWalletWithBiometric();
          }
        }
      } catch (error) {
        // Auto-fill failed or was cancelled, this is normal
        console.log('Auto-fill cancelled or failed:', error);
      }
    }

    // Hubi in unlockWalletWithBiometric function-ku si fiican u shaqeyso
async function unlockWalletWithBiometric() {
  try {
    console.log('Starting biometric unlock...');
    
    const encryptedKey = localStorage.getItem('laam_wallet_key');
    if (!encryptedKey) {
      throw new Error('No wallet found');
    }

    // Isticmaal FALLBACK KEY
    const fallbackKey = localStorage.getItem('laam_wallet_biometric_fallback');
    if (!fallbackKey) {
      throw new Error('No biometric fallback found');
    }

    const publicKey = localStorage.getItem('laam_wallet_public');
    const biometricKey = CryptoJS.SHA256(publicKey + "biometric_fallback").toString();
    
    // Isticmaal fallback key
    const decryptedKey = decryptSecretKey(fallbackKey, biometricKey);
    
    if (!decryptedKey) {
      throw new Error('Biometric decryption failed');
    }
    
    currentKeypair = StellarSdk.Keypair.fromSecret(decryptedKey);
    
    await loadWallet();
    watchDeposits();
    
    showSuccess('Wallet unlocked successfully with fingerprint!');
    document.getElementById('authSection').classList.add('hidden');
    document.getElementById('loggedInView').classList.remove('hidden');
    
    console.log('Biometric unlock completed successfully');
    
  } catch (error) {
    console.error('Biometric unlock failed:', error);
    throw error; // Ku sii tuur error-ka si event listener-ku u qabto
  }
}
    // Update wallet save to also create biometric-compatible version
    const originalImportAndSave = document.getElementById('importAndSaveBtn').onclick;
    document.getElementById('importAndSaveBtn').onclick = async function(e) {
      e.preventDefault();
      
      const secretKey = document.getElementById('secretKeyInput').value.trim();
      const password = document.getElementById('savePasswordInput').value;
      
      if (!secretKey.startsWith('S') || secretKey.length !== 56) {
        showError('Invalid secret key format.');
        return;
      }
      
      if (password.length < 8) {
        showError('Password must be at least 8 characters long.');
        return;
      }
      
      this.textContent = 'Importing...';
      this.disabled = true;
      
      try {
        currentKeypair = StellarSdk.Keypair.fromSecret(secretKey);
        
        // Encrypt and save with password
        const encryptedKey = encryptSecretKey(secretKey, password);
        localStorage.setItem('laam_wallet_key', encryptedKey);
        localStorage.setItem('laam_wallet_public', currentKeypair.publicKey());
        
        // Also create a version for potential biometric use
        const publicKey = currentKeypair.publicKey();
        const biometricCompatibleKey = CryptoJS.SHA256(publicKey + "biometric_fallback").toString();
        const biometricEncryptedKey = encryptSecretKey(secretKey, biometricCompatibleKey);
        localStorage.setItem('laam_wallet_biometric_fallback', biometricEncryptedKey);
        
        await loadWallet();
        
        showSuccess('Wallet imported successfully!');
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('loggedInView').classlassList.remove('hidden');
        
        // Show fingerprint setup option
        fingerprintAuth.updateUI();
        
      } catch (error) {
        console.error('Import error:', error);
        showError('Failed to import wallet: ' + error.message);
      } finally {
        this.textContent = 'Import and Save';
        this.disabled = false;
      }
    };

    // Update checkSavedWallet to show fingerprint options
    function checkSavedWallet() {
      const encryptedKey = localStorage.getItem('laam_wallet_key');
      if (encryptedKey) {
        document.getElementById('initialView').classList.add('hidden');
        document.getElementById('unlockView').classList.remove('hidden');
        
        // Update fingerprint UI
        fingerprintAuth.updateUI();
      }
    }

    // Your existing utility functions
    function showError(message) {
      const alertBox = document.getElementById("errorAlert");
      if (alertBox) {
        alertBox.textContent = "‚ùå " + message;
        alertBox.style.display = "block";
        setTimeout(() => {
          alertBox.style.display = "none";
        }, 4000);
      } else {
        alert("Error: " + message);
      }
    }

    function showSuccess(message) {
      const alertBox = document.getElementById("successAlert");
      if (alertBox) {
        alertBox.textContent = "‚úÖ " + message;
        alertBox.style.display = "block";
        setTimeout(() => {
          alertBox.style.display = "none";
        }, 3000);
      }
    }

    function encryptSecretKey(secretKey, password) {
      return CryptoJS.AES.encrypt(secretKey, password).toString();
    }

    function decryptSecretKey(encryptedKey, password) {
      try {
        const bytes = CryptoJS.AES.decrypt(encryptedKey, password);
        return bytes.toString(CryptoJS.enc.Utf8);
      } catch (e) {
        return null;
      }
    }
    // Initialize Stellar SDK
    function initializeStellar() {
      try {
        if (typeof StellarSdk !== 'undefined') {
          server = new StellarSdk.Server('https://horizon.stellar.org');
          console.log('Stellar SDK initialized successfully');
        } else {
          console.error('Stellar SDK not loaded');
          showError('Stellar SDK failed to load. Please refresh the page.');
        }
      } catch (error) {
        console.error('Error initializing Stellar SDK:', error);
        showError('Failed to initialize Stellar SDK: ' + error.message);
      }
    }
    
    function initializeAssets() {
      try {
        if (typeof StellarSdk !== 'undefined') {
          LAAM_ASSET = new StellarSdk.Asset(LAAM_TOKEN.code, LAAM_TOKEN.issuer);
          USDC_ASSET = new StellarSdk.Asset(USDC_TOKEN.code, USDC_TOKEN.issuer);
          console.log('Assets initialized successfully');
        }
      } catch (error) {
        console.error('Error initializing assets:', error);
      }
    }
    
    // Utility functions
    function showError(message) {
  const alertBox = document.getElementById("errorAlert");
  alertBox.textContent = "‚ùå " + message;
  alertBox.style.display = "block";
  setTimeout(() => {
    alertBox.style.display = "none";
  }, 4000);
      }
function showSuccess(message) {
  const alertBox = document.getElementById("successAlert");
  alertBox.textContent = "‚úÖ " + message;
  alertBox.style.display = "block";
  setTimeout(() => {
    alertBox.style.display = "none";
  }, 3000);
      }
    
    function formatAmount(amount) {
      return parseFloat(amount).toFixed(7);
    }
    
    function encryptSecretKey(secretKey, password) {
      return CryptoJS.AES.encrypt(secretKey, password).toString();
    }
    
    function decryptSecretKey(encryptedKey, password) {
      try {
        const bytes = CryptoJS.AES.decrypt(encryptedKey, password);
        return bytes.toString(CryptoJS.enc.Utf8);
      } catch (e) {
        return null;
      }
    }

    // Copy to clipboard function
    async function copyToClipboard(elementId, buttonElement) {
      try {
        const element = document.getElementById(elementId);
        const text = element.value;
        
        await navigator.clipboard.writeText(text);
        
        const originalText = buttonElement.textContent;
        buttonElement.textContent = 'Copied!';
        buttonElement.classList.add('copied');
        
        setTimeout(() => {
          buttonElement.textContent = originalText;
          buttonElement.classList.remove('copied');
        }, 2000);
        
      } catch (err) {
        console.error('Failed to copy:', err);
        const element = document.getElementById(elementId);
        element.select();
        element.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        const originalText = buttonElement.textContent;
        buttonElement.textContent = 'Copied!';
        buttonElement.classList.add('copied');
        
        setTimeout(() => {
          buttonElement.textContent = originalText;
          buttonElement.classList.remove('copied');
        }, 2000);
      }
    }

    // Key modal functions
    function openKeyModal(secretKey, publicKey) {
      document.getElementById('generatedSecretKey').value = secretKey;
      document.getElementById('generatedPublicKey').value = publicKey;
      document.getElementById('keyModal').classList.add('show');
    }

    function closeKeyModal() {
      document.getElementById('keyModal').classList.remove('show');
      generatedKeypair = null;
    }

    function useGeneratedAccount() {
      if (generatedKeypair) {
        document.getElementById('secretKeyInput').value = generatedKeypair.secret();
        closeKeyModal();
        showSuccess('Account keys have been filled in the form. Please create a password to save your wallet.');
      }
    }

    // Tab switching functionality
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      document.getElementById(tabName + 'Tab').classList.add('active');
      document.getElementById(tabName + 'Content').classList.add('active');
      
      currentTab = tabName;
      
      if (tabName === 'orderbook') {
        fetchOrderbook();
      } else if (tabName === 'lastTrades') {
        fetchTrades();
      } else if (tabName === 'overview') {
        updateOverview();
      }
    }

    // Fetch XLM price from API
    async function fetchXLMPrice() {
      try {
        const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=stellar&vs_currencies=usd');
        const data = await response.json();
        if (data.stellar && data.stellar.usd) {
          xlmPriceUSD = data.stellar.usd;
          console.log('XLM price updated:', xlmPriceUSD);
        }
      } catch (error) {
        console.error('Error fetching XLM price:', error);
        xlmPriceUSD = 0.12;
      }
    }

    // Create a beautiful price chart
    function createPriceChart() {
      const ctx = document.getElementById('priceChart').getContext('2d');
      
      // Sample price data (in a real app, this would come from an API)
      const prices = [0.12, 0.125, 0.128, 0.13, 0.132, 0.135, 0.133, 0.131, 0.129, 0.127, 0.125, 0.128, 0.13, 0.132, 0.135];
      const labels = Array.from({length: prices.length}, (_, i) => {
        const d = new Date();
        d.setHours(d.getHours() - (prices.length - i - 1));
        return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      });
      
      // Destroy existing chart if it exists
      if (priceChart) {
        priceChart.destroy();
      }
      
      priceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'LAAM/XLM Price',
            data: prices,
            borderColor: '#1976d2',
            backgroundColor: 'rgba(25, 118, 210, 0.1)',
            borderWidth: 2,
            pointRadius: 3,
            pointBackgroundColor: '#1976d2',
            pointBorderColor: '#fff',
            pointHoverRadius: 5,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.7)',
              titleFont: {
                size: 14
              },
              bodyFont: {
                size: 13
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              ticks: {
                maxRotation: 0,
                autoSkip: true,
                maxTicksLimit: 6
              }
            },
            y: {
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                callback: function(value) {
                  return value.toFixed(3) + ' XLM';
                }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index',
          }
        }
      });
    }

    // Update overview tab
    function updateOverview() {
      const currentPrice = 0.135000;
      const priceChange = 0.005000;
      const priceChangePercent = ((priceChange / (currentPrice - priceChange)) * 100).toFixed(2);
      
      document.getElementById('overviewLaamPriceXLM').textContent = currentPrice.toFixed(6);
      
      const priceChangeElement = document.getElementById('priceChange');
      priceChangeElement.textContent = `+${priceChange.toFixed(6)} (+${priceChangePercent}%)`;
      priceChangeElement.className = priceChange >= 0 ? 'price-change positive' : 'price-change negative';
      
      // Create or update the price chart
      createPriceChart();
    }

    // Fetch orderbook data
    async function fetchOrderbook() {
      try {
        console.log('Fetching orderbook data...');
        
        document.getElementById('asksBody').innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading asks...</td></tr>';
        document.getElementById('bidsBody').innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading bids...</td></tr>';
        document.getElementById('spreadValue').innerHTML = '<div class="loading-spinner"></div> Loading spread...';
        
        const orderbookUrl = `https://horizon.stellar.org/order_book?selling_asset_type=credit_alphanum4&selling_asset_code=${LAAM_TOKEN.code}&selling_asset_issuer=${LAAM_TOKEN.issuer}&buying_asset_type=native&limit=10`;
        
        const response = await fetch(orderbookUrl);
        const data = await response.json();
        
        console.log('Orderbook data received:', data);
        
        document.getElementById('asksBody').innerHTML = '';
        document.getElementById('bidsBody').innerHTML = '';
        
        const asksBody = document.getElementById('asksBody');
        if (data.asks && data.asks.length > 0) {
          orderbookData.asks = data.asks;
          data.asks.slice(0, 5).forEach(ask => {
            const row = document.createElement('tr');
            row.className = 'ask-row';
            const amount = parseFloat(ask.amount).toFixed(2);
            const price = parseFloat(ask.price).toFixed(7);
            const total = (parseFloat(ask.amount) * parseFloat(ask.price)).toFixed(7);
            
            row.innerHTML = `
              <td>${amount}</td>
              <td>${price}</td>
              <td>${total}</td>
            `;
            
            row.addEventListener('click', () => {
              if (document.getElementById('tradeModal').classList.contains('show')) {
                document.getElementById('modalPrice').value = price;
                calculateTotal();
              }
            });
            
            asksBody.appendChild(row);
          });
        } else {
          const sampleAsks = [
            { amount: '1000.00', price: '0.1450000', total: '145.0000000' },
            { amount: '750.00', price: '0.1400000', total: '105.0000000' },
            { amount: '500.00', price: '0.1380000', total: '69.0000000' },
            { amount: '1200.00', price: '0.1360000', total: '163.2000000' },
            { amount: '800.00', price: '0.1350000', total: '108.0000000' }
          ];
          
          sampleAsks.forEach(ask => {
            const row = document.createElement('tr');
            row.className = 'ask-row';
            row.innerHTML = `
              <td>${ask.amount}</td>
              <td>${ask.price}</td>
              <td>${ask.total}</td>
            `;
            
            row.addEventListener('click', () => {
              if (document.getElementById('tradeModal').classList.contains('show')) {
                document.getElementById('modalPrice').value = ask.price;
                calculateTotal();
              }
            });
            
            asksBody.appendChild(row);
          });
        }
        
        const bidsBody = document.getElementById('bidsBody');
        if (data.bids && data.bids.length > 0) {
          orderbookData.bids = data.bids;
          data.bids.slice(0, 5).forEach(bid => {
            const row = document.createElement('tr');
            row.className = 'bid-row';
            const amount = parseFloat(bid.amount).toFixed(2);
            const price = parseFloat(bid.price).toFixed(7);
            const total = (parseFloat(bid.amount) * parseFloat(bid.price)).toFixed(7);
            
            row.innerHTML = `
              <td>${amount}</td>
              <td>${price}</td>
              <td>${total}</td>
            `;
            
            row.addEventListener('click', () => {
              if (document.getElementById('tradeModal').classList.contains('show')) {
                document.getElementById('modalPrice').value = price;
                calculateTotal();
              }
            });
            
            bidsBody.appendChild(row);
          });
        } else {
          const sampleBids = [
            { amount: '900.00', price: '0.1300000', total: '117.0000000' },
            { amount: '1100.00', price: '0.1280000', total: '140.8000000' },
            { amount: '600.00', price: '0.1250000', total: '75.0000000' },
            { amount: '1500.00', price: '0.1220000', total: '183.0000000' },
            { amount: '700.00', price: '0.1200000', total: '84.0000000' }
          ];
          
          sampleBids.forEach(bid => {
            const row = document.createElement('tr');
            row.className = 'bid-row';
            row.innerHTML = `
              <td>${bid.amount}</td>
              <td>${bid.price}</td>
              <td>${bid.total}</td>
            `;
            
            row.addEventListener('click', () => {
              if (document.getElementById('tradeModal').classList.contains('show')) {
                document.getElementById('modalPrice').value = bid.price;
                calculateTotal();
              }
            });
            
            bidsBody.appendChild(row);
          });
        }
        
        let spread = 'No data';
        if (data.asks && data.asks.length > 0 && data.bids && data.bids.length > 0) {
          const bestAsk = parseFloat(data.asks[0].price);
          const bestBid = parseFloat(data.bids[0].price);
          const spreadValue = bestAsk - bestBid;
          const spreadPercent = ((spreadValue / bestBid) * 100).toFixed(2);
          spread = `Spread: ${spreadValue.toFixed(7)} XLM (${spreadPercent}%)`;
        } else {
          spread = 'Spread: 0.0150000 XLM (11.54%)';
        }
        
        document.getElementById('spreadValue').textContent = spread;
        
        console.log('Orderbook updated successfully');
        
      } catch (error) {
        console.error('Error fetching orderbook:', error);
        
        document.getElementById('asksBody').innerHTML = `
          <tr class="ask-row"><td>1000.00</td><td>0.1450000</td><td>145.0000000</td></tr>
          <tr class="ask-row"><td>750.00</td><td>0.1400000</td><td>105.0000000</td></tr>
          <tr class="ask-row"><td>500.00</td><td>0.1380000</td><td>69.0000000</td></tr>
          <tr class="ask-row"><td>1200.00</td><td>0.1360000</td><td>163.2000000</td></tr>
          <tr class="ask-row"><td>800.00</td><td>0.1350000</td><td>108.0000000</td></tr>
        `;
        
        document.getElementById('bidsBody').innerHTML = `
          <tr class="bid-row"><td>900.00</td><td>0.1300000</td><td>117.0000000</td></tr>
          <tr class="bid-row"><td>1100.00</td><td>0.1280000</td><td>140.8000000</td></tr>
          <tr class="bid-row"><td>600.00</td><td>0.1250000</td><td>75.0000000</td></tr>
          <tr class="bid-row"><td>1500.00</td><td>0.1220000</td><td>183.0000000</td></tr>
          <tr class="bid-row"><td>700.00</td><td>0.1200000</td><td>84.0000000</td></tr>
        `;
        
        document.getElementById('spreadValue').textContent = 'Spread: 0.0150000 XLM (11.54%)';
        
        document.querySelectorAll('.ask-row, .bid-row').forEach(row => {
          row.addEventListener('click', () => {
            const price = row.children[1].textContent;
            if (document.getElementById('tradeModal').classList.contains('show')) {
              document.getElementById('modalPrice').value = price;
              calculateTotal();
            }
          });
        });
      }
    }

    // Fetch trades data
    async function fetchTrades() {
      try {
        console.log('Fetching trades data...');
        
        document.getElementById('tradesBody').innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading trades...</td></tr>';
        
        const tradesUrl = `https://horizon.stellar.org/trades?base_asset_type=credit_alphanum4&base_asset_code=${LAAM_TOKEN.code}&base_asset_issuer=${LAAM_TOKEN.issuer}&counter_asset_type=native&limit=20&order=desc`;
        
        const response = await fetch(tradesUrl);
        const data = await response.json();
        
        console.log('Trades data received:', data);
        
        const tradesBody = document.getElementById('tradesBody');
        tradesBody.innerHTML = '';
        
        if (data._embedded && data._embedded.records && data._embedded.records.length > 0) {
          tradesData = data._embedded.records;
          data._embedded.records.slice(0, 10).forEach(trade => {
            const row = document.createElement('tr');
            const time = new Date(trade.ledger_close_time).toLocaleTimeString();
            const type = trade.base_is_seller ? 'SELL' : 'BUY';
            const price = parseFloat(trade.price.n / trade.price.d).toFixed(7);
            const amount = parseFloat(trade.base_amount).toFixed(2);
            
            row.innerHTML = `
              <td class="trade-time">${time}</td>
              <td class="${type.toLowerCase() === 'buy' ? 'trade-buy' : 'trade-sell'}">${type}</td>
              <td>${price}</td>
              <td>${amount}</td>
            `;
            tradesBody.appendChild(row);
          });
        } else {
          const sampleTrades = [
            { time: '14:32:15', type: 'BUY', price: '0.1350000', amount: '250.00' },
            { time: '14:28:42', type: 'SELL', price: '0.1340000', amount: '180.50' },
            { time: '14:25:18', type: 'BUY', price: '0.1345000', amount: '320.75' },
            { time: '14:22:03', type: 'BUY', price: '0.1338000', amount: '150.25' },
            { time: '14:18:47', type: 'SELL', price: '0.1335000', amount: '400.00' },
            { time: '14:15:22', type: 'BUY', price: '0.1342000', amount: '275.50' },
            { time: '14:12:08', type: 'SELL', price: '0.1330000', amount: '190.75' },
            { time: '14:08:35', type: 'BUY', price: '0.1348000', amount: '225.00' }
          ];
          
          sampleTrades.forEach(trade => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="trade-time">${trade.time}</td>
              <td class="${trade.type.toLowerCase() === 'buy' ? 'trade-buy' : 'trade-sell'}">${trade.type}</td>
              <td>${trade.price}</td>
              <td>${trade.amount}</td>
            `;
            tradesBody.appendChild(row);
          });
        }
        
        console.log('Trades updated successfully');
        
      } catch (error) {
        console.error('Error fetching trades:', error);
        
        const sampleTrades = [
          { time: '14:32:15', type: 'BUY', price: '0.1350000', amount: '250.00' },
          { time: '14:28:42', type: 'SELL', price: '0.1340000', amount: '180.50' },
          { time: '14:25:18', type: 'BUY', price: '0.1345000', amount: '320.75' },
          { time: '14:22:03', type: 'BUY', price: '0.1338000', amount: '150.25' },
          { time: '14:18:47', type: 'SELL', price: '0.1335000', amount: '400.00' }
        ];
        
        const tradesBody = document.getElementById('tradesBody');
        tradesBody.innerHTML = '';
        
        sampleTrades.forEach(trade => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="trade-time">${trade.time}</td>
            <td class="${trade.type.toLowerCase() === 'buy' ? 'trade-buy' : 'trade-sell'}">${trade.type}</td>
            <td>${trade.price}</td>
            <td>${trade.amount}</td>
          `;
          tradesBody.appendChild(row);
        });
      }
    }

  // Update balance display function
async function updateBalanceDisplay() {
  if (!currentKeypair || !server) {
    console.log('No keypair or server available');
    return;
  }

  try {
    console.log('Loading account data...');
    const account = await server.loadAccount(currentKeypair.publicKey());

    let xlmBalance = 0;
    let laamBalance = 0;
    let usdcBalance = 0;

    account.balances.forEach(balance => {
      if (balance.asset_type === 'native') {
        xlmBalance = parseFloat(balance.balance);
      } else if (
        balance.asset_code === LAAM_TOKEN.code &&
        balance.asset_issuer === LAAM_TOKEN.issuer
      ) {
        laamBalance = parseFloat(balance.balance);
      } else if (
        balance.asset_code === USDC_TOKEN.code &&
        balance.asset_issuer === USDC_TOKEN.issuer
      ) {
        usdcBalance = parseFloat(balance.balance);
      }
    });

    // ‚úÖ XLM price + balance
    document.getElementById('xlmBal').textContent = xlmBalance.toFixed(2);
    document.getElementById('xlmBalUsd').textContent = (xlmBalance * xlmPriceUSD).toFixed(2);
    document.getElementById('xlmPrice').textContent = xlmPriceUSD.toFixed(3);

    // Sample % change (XLM)
    let xlmChange = 2.06;
    const xlmChangeEl = document.getElementById('xlmChange');
    xlmChangeEl.textContent = (xlmChange >= 0 ? '+' : '') + xlmChange.toFixed(2) + '%';
    xlmChangeEl.className = 'price-change ' + (xlmChange >= 0 ? 'positive' : 'negative');

    // ‚úÖ Laam part
    const bestSellOfferXLM = await getBestSellOfferPrice();
    const laamPriceUSD = bestSellOfferXLM * xlmPriceUSD;

    LAAM_TOKEN.currentPrice = laamPriceUSD;

    document.getElementById('laamBal').textContent = laamBalance.toFixed(2);
    document.getElementById('laamBalUsd').textContent = (laamBalance * laamPriceUSD).toFixed(2);
    document.getElementById('laamPrice').textContent = laamPriceUSD.toFixed(6);

    // Sample % change (Laam)
    let laamChange = -12.67;
    const laamChangeEl = document.getElementById('laamChange');
    laamChangeEl.textContent = (laamChange >= 0 ? '+' : '') + laamChange.toFixed(2) + '%';
    laamChangeEl.className = 'price-change ' + (laamChange >= 0 ? 'positive' : 'negative');

    // ‚úÖ USDC part
    document.getElementById('usdcBal').textContent = usdcBalance.toFixed(2);
    document.getElementById('usdcBalUsd').textContent = usdcBalance.toFixed(2);
    document.getElementById('usdcPrice').textContent = "1.00";

    const usdcChangeEl = document.getElementById('usdcChange');
    usdcChangeEl.textContent = "0.00%";
    usdcChangeEl.className = 'price-change';

    updateTotalAssets();

    console.log('Balance display updated successfully');

  } catch (error) {
    console.error('Error updating balance display:', error);
    showError('Failed to load account balance: ' + error.message);
  }
}

// Helper: get best sell offer price (Laam/XLM)
async function getBestSellOfferPrice() {
  try {
    const orderbookUrl = `https://horizon.stellar.org/order_book?selling_asset_type=credit_alphanum4&selling_asset_code=${LAAM_TOKEN.code}&selling_asset_issuer=${LAAM_TOKEN.issuer}&buying_asset_type=native&limit=1`;
    const response = await fetch(orderbookUrl);
    const data = await response.json();

    if (data.asks && data.asks.length > 0) {
      return parseFloat(data.asks[0].price); // best sell offer
    }
  } catch (e) {
    console.error("Failed to fetch best sell offer:", e);
  }
  return LAAM_TOKEN.currentPrice; // fallback
}

// Update total assets value
function updateTotalAssets() {
  const xlmUsd = parseFloat(document.getElementById('xlmBalUsd').textContent) || 0;
  const laamUsd = parseFloat(document.getElementById('laamBalUsd').textContent) || 0;
  const usdcUsd = parseFloat(document.getElementById('usdcBalUsd').textContent) || 0;

  const totalAssets = (xlmUsd + laamUsd + usdcUsd).toFixed(2);
  document.getElementById('totalAssets').textContent = totalAssets;
}
    // Load wallet function
    async function loadWallet() {
      if (!currentKeypair) {
        console.error('No keypair available');
        return;
      }

      try {
        console.log('Loading wallet for:', currentKeypair.publicKey());
        
        await fetchXLMPrice();
        await updateBalanceDisplay();
        
        if (currentTab === 'orderbook') {
          await fetchOrderbook();
        } else if (currentTab === 'lastTrades') {
          await fetchTrades();
        } else if (currentTab === 'overview') {
          updateOverview();
        }
        
        console.log('Wallet loaded successfully');
        
      } catch (error) {
        console.error('Error loading wallet:', error);
        
        // Only show error if wallet view is visible
        if (!document.getElementById('loggedInView').classList.contains('hidden')) {
          showError('Failed to load wallet: ' + error.message);
        }
      }
    }

    // Check if wallet exists in localStorage
    function checkSavedWallet() {
  const encryptedKey = localStorage.getItem('laam_wallet_key');
  const fallbackKey = localStorage.getItem('laam_wallet_biometric_fallback');
  
  if (encryptedKey) {
    document.getElementById('initialView').classList.add('hidden');
    document.getElementById('unlockView').classList.remove('hidden');
    
    // Update fingerprint UI based on fallback availability
    if (fallbackKey) {
      document.getElementById('fingerprintStatus').textContent = 'Fingerprint unlock ready';
      document.getElementById('fingerprintStatus').className = 'fingerprint-status enabled';
      document.getElementById('fingerprintUnlockBtn').disabled = false;
    }
  }
}

    // Trade modal functions
    function openTradeModal(mode) {
      currentTradeMode = mode;
      const modal = document.getElementById('tradeModal');
      const title = document.getElementById('modalTitle');
      const panelTitle = document.getElementById('panelTitle');
      const availBalance = document.getElementById('availBalance');
      const modalBuyBtn = document.getElementById('modalBuyBtn');
      
      if (mode === 'buy') {
        title.textContent = 'Buy Laam';
        panelTitle.textContent = 'Buy Laam';
        modalBuyBtn.textContent = 'Buy Laam';
        modalBuyBtn.className = 'cta buy';
        
        const xlmBal = document.getElementById('xlmBal').textContent;
        availBalance.textContent = `${xlmBal} XLM`;
      } else {
        title.textContent = 'Sell Laam';
        panelTitle.textContent = 'Sell Laam';
        modalBuyBtn.textContent = 'Sell Laam';
        modalBuyBtn.className = 'cta sell';
        const laamBal = document.getElementById('laamBal').textContent;
        availBalance.textContent = `${laamBal} Laam`;
      }
      
      modal.classList.add('show');
    }

    function closeTradeModal() {
      const modal = document.getElementById('tradeModal');
      modal.classList.remove('show');
      
      document.getElementById('modalPrice').value = '';
      document.getElementById('modalAmount').value = '';
      document.getElementById('modalTotal').value = '';
    }

    // Calculate total in modal
    function calculateTotal() {
      const price = parseFloat(document.getElementById('modalPrice').value) || 0;
      const amount = parseFloat(document.getElementById('modalAmount').value) || 0;
      const total = price * amount;
      document.getElementById('modalTotal').value = total.toFixed(7);
    }

    // Create offer function
    async function createOffer(mode, amount, price) {
      if (!currentKeypair || !LAAM_ASSET) {
        throw new Error('Wallet not loaded or asset not initialized.');
      }

      try {
        const account = await server.loadAccount(currentKeypair.publicKey());
        
        let operation;
        if (mode === 'buy') {
          operation = StellarSdk.Operation.manageBuyOffer({
            selling: StellarSdk.Asset.native(),
            buying: LAAM_ASSET,
            buyAmount: amount.toString(),
            price: price.toString(),
            offerId: '0'
          });
        } else {
          operation = StellarSdk.Operation.manageSellOffer({
            selling: LAAM_ASSET,
            buying: StellarSdk.Asset.native(),
            amount: amount.toString(),
            price: price.toString(),
            offerId: '0'
          });
        }
        
        const transaction = new StellarSdk.TransactionBuilder(account, {
          fee: StellarSdk.BASE_FEE,
          networkPassphrase: StellarSdk.Networks.PUBLIC
        })
        .addOperation(operation)
        .setTimeout(180)
        .build();
        transaction.sign(currentKeypair);
        
        const result = await server.submitTransaction(transaction);
        return result;
        
      } catch (error) {
        console.error('Trade execution error:', error);
        throw error;
      }
    }

    // Load user offers
    async function loadUserOffers() {
  try {
    if (!currentKeypair || !server) {
      throw new Error('Wallet not loaded');
    }
    
    const offers = await server.offers().forAccount(currentKeypair.publicKey()).call();
    
    const laamOffers = offers.records.filter(offer => {
      const sellingAsset = offer.selling;
      const buyingAsset = offer.buying;
      
      const isSellingLaam = sellingAsset.asset_type !== 'native' && 
                           sellingAsset.asset_code === LAAM_TOKEN.code && 
                           sellingAsset.asset_issuer === LAAM_TOKEN.issuer;
      
      const isBuyingLaam = buyingAsset.asset_type !== 'native' && 
                          buyingAsset.asset_code === LAAM_TOKEN.code && 
                          buyingAsset.asset_issuer === LAAM_TOKEN.issuer;
      
      return isSellingLaam || isBuyingLaam;
    });
    
    return laamOffers;
  } catch (error) {
    console.error('Error loading user offers:', error);
    throw error;
  }
}

    // Edit offer function
async function editOffer(offerId, newAmount, newPrice) {
  try {
    const account = await server.loadAccount(currentKeypair.publicKey());
    const offer = await server.offers().offer(offerId).call();
    
    // Hagaaji qaybta asset creation
    const sellingAsset = offer.selling.asset_type === 'native' 
      ? StellarSdk.Asset.native()
      : new StellarSdk.Asset(offer.selling.asset_code, offer.selling.asset_issuer);
    
    const buyingAsset = offer.buying.asset_type === 'native' 
      ? StellarSdk.Asset.native()
      : new StellarSdk.Asset(offer.buying.asset_code, offer.buying.asset_issuer);
    
    // Go'aami nooca offer-ka (sell ama buy)
    const isSellOffer = offer.selling.asset_code === LAAM_TOKEN.code;
    
    let operation;
    if (isSellOffer) {
      operation = StellarSdk.Operation.manageSellOffer({
        selling: sellingAsset,
        buying: buyingAsset,
        amount: newAmount.toString(),
        price: newPrice.toString(),
        offerId: offerId
      });
    } else {
      operation = StellarSdk.Operation.manageBuyOffer({
        selling: sellingAsset,
        buying: buyingAsset,
        buyAmount: newAmount.toString(),
        price: newPrice.toString(),
        offerId: offerId
      });
    }

    const transaction = new StellarSdk.TransactionBuilder(account, {
      fee: StellarSdk.BASE_FEE,
      networkPassphrase: StellarSdk.Networks.PUBLIC
    })
    .addOperation(operation)
    .setTimeout(180)
    .build();
    
    transaction.sign(currentKeypair);
    const result = await server.submitTransaction(transaction);
    return result;
  } catch (error) {
    throw error;
  }
}

    // Cancel offer function
async function cancelOffer(offerId) {
  try {
    const account = await server.loadAccount(currentKeypair.publicKey());
    const offer = await server.offers().offer(offerId).call();
    
    // Isla hagaajinta asset creation
    const sellingAsset = offer.selling.asset_type === 'native' 
      ? StellarSdk.Asset.native()
      : new StellarSdk.Asset(offer.selling.asset_code, offer.selling.asset_issuer);
    
    const buyingAsset = offer.buying.asset_type === 'native' 
      ? StellarSdk.Asset.native()
      : new StellarSdk.Asset(offer.buying.asset_code, offer.buying.asset_issuer);
    
    const isSellOffer = offer.selling.asset_code === LAAM_TOKEN.code;
    
    let operation;
    if (isSellOffer) {
      operation = StellarSdk.Operation.manageSellOffer({
        selling: sellingAsset,
        buying: buyingAsset,
        amount: '0',
        price: '1',
        offerId: offerId
      });
    } else {
      operation = StellarSdk.Operation.manageBuyOffer({
        selling: sellingAsset,
        buying: buyingAsset,
        buyAmount: '0',
        price: '1',
        offerId: offerId
      });
    }

    const transaction = new StellarSdk.TransactionBuilder(account, {
      fee: StellarSdk.BASE_FEE,
      networkPassphrase: StellarSdk.Networks.PUBLIC
    })
    .addOperation(operation)
    .setTimeout(180)
    .build();
    
    transaction.sign(currentKeypair);
    const result = await server.submitTransaction(transaction);
    return result;
  } catch (error) {
    throw error;
  }
}

    // My Orders Modal functions
    async function openMyOrdersModal() {
  if (!currentKeypair) {
    showError('Please unlock your wallet first');
    return;
  }
  
  const modal = document.getElementById('myOrdersModal');
  const ordersList = document.getElementById('ordersList');
  
  modal.classList.add('show');
  ordersList.innerHTML = '<div style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading orders...</div>';
  
  try {
    const offers = await loadUserOffers();
    
    if (offers.length === 0) {
      ordersList.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">No active orders found</p>';
      return;
    }
    
    let html = '';
    offers.forEach(offer => {
      const isSell = offer.selling.asset_code === LAAM_TOKEN.code;
      const price = parseFloat(offer.price).toFixed(7);
      const amount = parseFloat(offer.amount).toFixed(2);
      
      html += `
        <div class="order-item" data-id="${offer.id}">
          <div class="order-type ${isSell ? 'sell' : 'buy'}">${isSell ? 'SELL' : 'BUY'}</div>
          <div class="order-amount">${amount} Laam</div>
          <div class="order-price">${price} XLM</div>
        </div>
      `;
    });
    
    ordersList.innerHTML = html;
    
    // Event listeners for order selection
    document.querySelectorAll('.order-item').forEach(item => {
      item.addEventListener('click', function() {
        document.querySelectorAll('.order-item').forEach(i => i.classList.remove('selected'));
        this.classList.add('selected');
        currentOfferId = this.getAttribute('data-id');
      });
    });
    
  } catch (error) {
    console.error('Error loading offers:', error);
    ordersList.innerHTML = '<p style="text-align:center; padding:20px; color:#dc3545;">Error loading orders</p>';
  }
}

    function closeMyOrdersModal() {
      const modal = document.getElementById('myOrdersModal');
      modal.classList.remove('show');
      currentOfferId = null;
    }

    // Edit offer prompt
async function promptEditOffer() {
  if (!currentOfferId) {
    showError('Please select an order first');
    return;
  }
  
  try {
    const offer = await server.offers().offer(currentOfferId).call();
    
    // Keydi nooca offer-ka
    currentOfferType = offer.selling.asset_code === LAAM_TOKEN.code ? 'sell' : 'buy';
    
    document.getElementById('editAmount').value = parseFloat(offer.amount).toFixed(7);
    document.getElementById('editPrice').value = parseFloat(offer.price).toFixed(7);
    
    document.getElementById('editOrderModal').classList.add('show');
  } catch (error) {
    console.error('Error loading offer details:', error);
    showError('Failed to load offer details: ' + error.message);
  }
}

    function closeEditModal() {
      document.getElementById('editOrderModal').classList.remove('show');
    }

    // Confirm cancel offer
    async function confirmCancelOffer() {
      if (!currentOfferId) {
        showError('Please select an order first');
        return;
      }
      
      if (confirm('Are you sure you want to cancel this order?')) {
        try {
          await cancelOffer(currentOfferId);
          showSuccess('Order cancelled successfully!');
          closeMyOrdersModal();
          // Refresh the orders list
          await openMyOrdersModal();
        } catch (error) {
          showError('Failed to cancel order: ' + error.message);
        }
      }
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing...');
      
      initializeStellar();
      initializeAssets();
      
      if (typeof StellarSdk === 'undefined') {
        console.error('StellarSdk is not defined');
        showError('Stellar SDK failed to load. Please refresh the page.');
        return;
      }
      
      if (typeof CryptoJS === 'undefined') {
        console.error('CryptoJS is not defined');
        showError('CryptoJS failed to load. Please refresh the page.');
        return;
      }
  // KU DAR HALKAN - dhamaadka DOMContentLoaded
  document.getElementById('confirmEditBtn').addEventListener('click', async function() {
    const newAmount = parseFloat(document.getElementById('editAmount').value);
    const newPrice = parseFloat(document.getElementById('editPrice').value);
    
    if (!newAmount || !newPrice || newAmount <= 0 || newPrice <= 0) {
      showError('Please enter valid amount and price');
      return;
    }
    
    this.disabled = true;
    this.textContent = 'Updating...';
    
    try {
      await editOffer(currentOfferId, newAmount, newPrice);
      showSuccess('Order updated successfully!');
      closeEditModal();
      closeMyOrdersModal();
      
      await fetchOrderbook();
      await updateBalanceDisplay();
      
    } catch (error) {
      console.error('Edit order error:', error);
      showError('Failed to update order: ' + error.message);
    } finally {
      this.disabled = false;
      this.textContent = 'Update Order';
    }
  });
      // Habkan waa ka fiican - ma beddelayo innerHTML
const myOrdersBtn = document.createElement('span');
myOrdersBtn.className = 'icon';
myOrdersBtn.id = 'myOrdersBtn';
myOrdersBtn.textContent = 'üìã';
myOrdersBtn.onclick = openMyOrdersModal;
      
console.log('All libraries loaded successfully');
      
      checkSavedWallet();
      
      document.querySelectorAll('.form-input').forEach(input => {
        input.addEventListener('focus', function() {
          this.parentElement.style.transform = 'scale(1.02)';
        });
        
        input.addEventListener('blur', function() {
          this.parentElement.style.transform = 'scale(1)';
        });
      });

      // Ku dar qaybtaan halkaa "Import and Save"
document.getElementById('importAndSaveBtn').addEventListener('click', async function(e) {
  e.preventDefault();
  
  const secretKey = document.getElementById('secretKeyInput').value.trim();
  const password = document.getElementById('savePasswordInput').value;
  
  if (!secretKey.startsWith('S') || secretKey.length !== 56) {
    showError('Invalid secret key format.');
    return;
  }
  
  if (password.length < 8) {
    showError('Password must be at least 8 characters long.');
    return;
  }
  
  this.textContent = 'Importing...';
  this.disabled = true;
  
  try {
    currentKeypair = StellarSdk.Keypair.fromSecret(secretKey);
    
    // 1. Save with password (original)
    const encryptedKey = encryptSecretKey(secretKey, password);
    localStorage.setItem('laam_wallet_key', encryptedKey);
    localStorage.setItem('laam_wallet_public', currentKeypair.publicKey());
    
    // 2. Create BIOMETRIC FALLBACK (NEW)
    const biometricKey = CryptoJS.SHA256(currentKeypair.publicKey() + "biometric_fallback").toString();
    const biometricEncryptedKey = encryptSecretKey(secretKey, biometricKey);
    localStorage.setItem('laam_wallet_biometric_fallback', biometricEncryptedKey);
    
    await loadWallet();
    
    showSuccess('Wallet imported successfully! Biometric setup ready.');
    document.getElementById('authSection').classList.add('hidden');
    document.getElementById('loggedInView').classList.remove('hidden');
    
  } catch (error) {
    console.error('Import error:', error);
    showError('Failed to import wallet: ' + error.message);
  } finally {
    this.textContent = 'Import and Save';
    this.disabled = false;
  }
});
      
      document.getElementById('generateAccountBtn').addEventListener('click', function() {
        console.log('Generate account button clicked');
        
        try {
          generatedKeypair = StellarSdk.Keypair.random();
          const secretKey = generatedKeypair.secret();
          const publicKey = generatedKeypair.publicKey();
          
          console.log('New keypair generated successfully');
          
          openKeyModal(secretKey, publicKey);
          
        } catch (error) {
          console.error('Generate account error:', error);
          showError('Failed to generate account: ' + error.message);
        }
      });
      
      document.getElementById('unlockBtn').addEventListener('click', async function() {
        const password = document.getElementById('walletPassword').value;
        const encryptedKey = localStorage.getItem('laam_wallet_key');
        
        if (!encryptedKey) {
          showError('No wallet found. Please import a wallet first.');
          return;
        }
        
        if (!password) {
          showError('Please enter your password.');
          return;
        }
        
        this.textContent = 'Unlocking...';
        this.disabled = true;
        
        try {
          const decryptedKey = decryptSecretKey(encryptedKey, password);
          
          if (!decryptedKey) {
            showError('Incorrect password.');
            return;
          }
          
          currentKeypair = StellarSdk.Keypair.fromSecret(decryptedKey);
          
          await loadWallet();
          watchDeposits();
         
         function watchDeposits() {
  if (!currentKeypair) {
    console.warn("No wallet loaded, cannot watch deposits.");
    return;
  }

  const publicKey = currentKeypair.publicKey();
  console.log("üëÇ Watching deposits for:", publicKey);

  server.payments()
    .forAccount(publicKey)
    .cursor("now") // wixii cusub kadib unlock
    .stream({
      onmessage: function (payment) {
        let destination = null;

        // Payment ama create_account ayaa noqon kara
        if (payment.type === "payment") {
          destination = payment.to;
        } else if (payment.type === "create_account") {
          destination = payment.account;
        }

        if (destination === publicKey) {
          const amount = payment.amount;
          const asset = payment.asset_type === "native" ? "XLM" : payment.asset_code;

          console.log("üí∞ Deposit received:", amount, asset);
          showDepositNotification(amount, asset);
        }
      },
      onerror: function (err) {
        console.error("Deposit stream error:", err);
      }
    });
}

function showDepositNotification(amount, asset) {
  const notif = document.createElement("div");
  notif.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4caf50;
    color: white;
    padding: 14px 20px;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    z-index: 99999;
    font-weight: 600;
    font-family: sans-serif;
    font-size: 14px;
    animation: slideIn 0.3s ease-out;
  `;
  notif.textContent = `‚úÖ Deposit of ${amount} ${asset} received`;
  document.body.appendChild(notif);

  setTimeout(() => notif.remove(), 6000);
}

// Animation
const style = document.createElement("style");
style.innerHTML = `
@keyframes slideIn {
  from { transform: translateX(120%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}`;
       
document.head.appendChild(style);

// Token Modal Functions
    function openTokenModal(token) {
      selectedToken = token;
      
      // Set modal content based on token
      const modalTokenName = document.getElementById('modalTokenName');
      const modalTokenIcon = document.getElementById('modalTokenIcon');
      const modalTokenBalance = document.getElementById('modalTokenBalance');
      const modalTokenValue = document.getElementById('modalTokenValue');
      
      // Set token details
      modalTokenName.textContent = token;
      
      // Set token icon
      if (token === 'XLM') {
        modalTokenIcon.src = 'https://res.coinpaper.com/coinpaper/stellar_xlm_logo_07021d63c0.png';
      } else if (token === 'LAAM') {
        modalTokenIcon.src = 'https://i.ibb.co/r28SP1bN/20250802-225108.png';
      } else if (token === 'USDC') {
        modalTokenIcon.src = 'https://i.ibb.co/r2qNFs22/images-2.png';
      }
      
      // Set token balance and value
      const balanceElement = document.getElementById(token.toLowerCase() + 'Bal');
      const valueElement = document.getElementById(token.toLowerCase() + 'BalUsd');
      
      modalTokenBalance.textContent = balanceElement ? balanceElement.textContent + ' ' + token : '0 ' + token;
      modalTokenValue.textContent = valueElement ? '$' + valueElement.textContent : '$0.00';
      
      // Show modal
      document.getElementById('tokenModal').classList.add('show');
    }

    function closeTokenModal() {
      document.getElementById('tokenModal').classList.remove('show');
      selectedToken = null;
    }

    // Open Send Wizard for selected token
    function openSendWizardForToken() {
      if (selectedToken) {
        // Set the asset in send wizard
        document.getElementById('sendAsset').value = selectedToken;
        closeTokenModal();
        
        // Open send wizard
        document.getElementById('sendWizard').style.display = 'block';
        document.getElementById('wizardOverlay').style.display = 'block';
        showStep(1);
      }
    }

    // Open Receive for selected token
    function openReceiveForToken() {
      closeTokenModal();
      
      // Show receive address modal
      const publicKey = currentKeypair ? currentKeypair.publicKey() : "GB7WZHXV4FCATLV2LZFLYU7A74BD5WALPUMOU4CY4DRJGJIL3EW3DGXA";

      const receiveModal = document.createElement('div');
      receiveModal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.7);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
      `;

      receiveModal.innerHTML = `
          <div style="background: white; padding: 25px; border-radius: 20px; text-align: center; max-width: 320px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
              <h3 style="color: #1976d2; margin-top: 0; margin-bottom: 20px;">Receive ${selectedToken}</h3>
              <div style="background: white; padding: 15px; margin: 15px 0; border-radius: 12px; border: 1px solid #e0e0e0;">
                  <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${publicKey}" 
                       alt="QR Code" style="max-width: 180px; border-radius: 8px;">
              </div>
              <div style="font-size: 14px; color: #666; margin-bottom: 10px;">Scan this QR code or copy the address below</div>
              <div id="publicKeyText" class="mono" 
                   style="font-size: 13px; margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 12px; word-break: break-all; line-height: 1.5;">
                  ${publicKey}
              </div>
              <button id="btnCopy" 
                      style="background: #4caf50; color: white; border: none; padding: 10px 22px; 
                             border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 10px; margin-right: 10px;">
                  Copy
              </button>
              <button onclick="this.parentElement.parentElement.remove()" 
                      style="background: #1976d2; color: white; border: none; padding: 12px 24px; 
                             border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 10px;">
                     Close
              </button>
          </div>
      `;

      document.body.appendChild(receiveModal);

      // Add event listener to the Copy button
      document.getElementById("btnCopy").addEventListener("click", function () {
          copyToClipboard("publicKeyText");
      });
    }

    // Copy to clipboard function
    async function copyToClipboard(elementId) {
      try {
        const element = document.getElementById(elementId);
        const text = element.textContent;
        
        await navigator.clipboard.writeText(text);
        showToast('Copied to clipboard!');
      } catch (err) {
        console.error('Failed to copy:', err);
        // Fallback for older browsers
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand("copy");
        document.body.removeChild(textArea);
        showToast('Copied to clipboard!');
      }
    }

    // Toast notification
    function showToast(message) {
      const toast = document.createElement("div");
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        background: #333; color: #fff; padding: 10px 20px; border-radius: 8px;
        font-size: 14px; z-index: 10001; opacity: 0; transition: opacity 0.3s;
      `;
      document.body.appendChild(toast);
      setTimeout(() => { toast.style.opacity = "1"; }, 50);
      setTimeout(() => { toast.style.opacity = "0"; }, 2000);
      setTimeout(() => { toast.remove(); }, 2500);
    }

    // Add event listeners when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      initializeStellar();
      
function debugFingerprintFlow() {
  console.log('=== Fingerprint Debug ===');
  console.log('1. Fingerprint supported:', fingerprintAuth.isSupported);
  console.log('2. Fingerprint setup:', fingerprintAuth.isSetup);
  console.log('3. Stored credential:', !!fingerprintAuth.credentialId);
  console.log('4. Main wallet key:', !!localStorage.getItem('laam_wallet_key'));
  console.log('5. Fallback key:', !!localStorage.getItem('laam_wallet_biometric_fallback'));
  console.log('6. Current keypair:', !!currentKeypair);
}

async function testFingerprintUnlock() {
  console.log('üß™ Testing fingerprint unlock...');
  debugFingerprintFlow();
  
  try {
    await fingerprintAuth.authenticate();
    console.log('‚úÖ Test passed - authentication successful');
  } catch (error) {
    console.log('‚ùå Test failed:', error.message);
  }
}
      // Add click event listeners to asset items
      document.querySelectorAll('.asset-item').forEach(item => {
        item.addEventListener('click', function() {
          const token = this.getAttribute('data-token');
          openTokenModal(token);
        });
      });
      
      // Close modal when clicking outside
      document.getElementById('tokenModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeTokenModal();
        }
      });

      // Waxyaabaha kale ee initialization
      // ...
    });

    // Send Wizard Functions (halkani waa tusaale, waxaad ku daraysaa function-kaaga send)
    function showStep(step) {
      // Implementation for wizard steps
      console.log('Show step:', step);
    }
          
          showSuccess('Wallet unlocked successfully!');
          document.getElementById('authSection').classList.add('hidden');
          document.getElementById('loggedInView').classList.remove('hidden');
          
        } catch (error) {
          console.error('Unlock error:', error);
          showError('Failed to unlock wallet: ' + error.message);
        } finally {
          this.textContent = 'Unlock';
          this.disabled = false;
        }
      });
      
      document.getElementById('resetWalletLink').addEventListener('click', function(e) {
        e.preventDefault();
        
        if (confirm('This will remove your saved wallet. Are you sure?')) {
          localStorage.removeItem('laam_wallet_key');
          localStorage.removeItem('laam_wallet_public');
          
          document.getElementById('unlockView').classList.add('hidden');
          document.getElementById('initialView').classList.remove('hidden');
          
          showSuccess('Wallet reset successfully.');
        }
      });
      
      document.getElementById('logoutBtn').addEventListener('click', function() {
        currentKeypair = null;
        
        document.getElementById('loggedInView').classList.add('hidden');
        document.getElementById('authSection').classList.remove('hidden');
        
        const encryptedKey = localStorage.getItem('laam_wallet_key');
        if (encryptedKey) {
          document.getElementById('initialView').classList.add('hidden');
          document.getElementById('unlockView').classList.remove('hidden');
        } else {
          document.getElementById('unlockView').classList.add('hidden');
          document.getElementById('initialView').classList.remove('hidden');
        }
      });
      
      document.getElementById('addTrustlineBtn').addEventListener('click', async function() {
        if (!currentKeypair || !LAAM_ASSET) {
          showError('Wallet not loaded or asset not initialized.');
          return;
        }
        
        this.textContent = 'Adding Trustline...';
        this.disabled = true;
        
        try {
          const account = await server.loadAccount(currentKeypair.publicKey());
          
          const transaction = new StellarSdk.TransactionBuilder(account, {
            fee: StellarSdk.BASE_FEE,
            networkPassphrase: StellarSdk.Networks.PUBLIC
          })
          .addOperation(StellarSdk.Operation.changeTrust({
            asset: LAAM_ASSET
          }))
          .setTimeout(180)
          .build();
          
          transaction.sign(currentKeypair);
          
          const result = await server.submitTransaction(transaction);
          
          showSuccess('Laam trustline added successfully!');
          
          await updateBalanceDisplay();
          
        } catch (error) {
          console.error('Add trustline error:', error);
          showError('Failed to add trustline: ' + error.message);
        } finally {
          this.textContent = 'Add Laam Trustline';
          this.disabled = false;
        }
      });
       
      // Event listener for the Receive button
document.getElementById('btnReceive').addEventListener('click', function () {
    const publicKey = currentKeypair ? currentKeypair.publicKey() : "GB7WZHXV4FCATLV2LZFLYU7A74BD5WALPUMOU4CY4DRJGJIL3EW3DGXA";

    const receiveModal = document.createElement('div');
    receiveModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    `;

    receiveModal.innerHTML = `
        <div style="background: white; padding: 25px; border-radius: 20px; text-align: center; max-width: 320px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <h3 style="color: #1976d2; margin-top: 0; margin-bottom: 20px;">Your Receive Address</h3>
            <div style="background: white; padding: 15px; margin: 15px 0; border-radius: 12px; border: 1px solid #e0e0e0;">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${publicKey}" 
                     alt="QR Code" style="max-width: 180px; border-radius: 8px;">
            </div>
            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">Scan this QR code or copy the address below</div>
            <div id="publicKeyText" class="mono" 
                 style="font-size: 13px; margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 12px; word-break: break-all; line-height: 1.5;">
                ${publicKey}
            </div>
            <button id="btnCopy" 
                    style="background: #4caf50; color: white; border: none; padding: 10px 22px; 
                           border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 10px; margin-right: 10px;">
                Copy
            </button>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="background: #1976d2; color: white; border: none; padding: 12px 24px; 
                           border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 10px;">
                   ‚ãò
            </button>
        </div>
    `;

    document.body.appendChild(receiveModal);

    // Add event listener to the Copy button
    document.getElementById("btnCopy").addEventListener("click", function () {
        copyToClipboard("publicKeyText");
    });
});

// Copy helper using toast
function copyToClipboard(elementId) {
    try {
        const text = document.getElementById(elementId).textContent.trim();

        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showToast("Copied to clipboard!");
            }).catch(err => {
                fallbackCopy(text);
            });
        } else {
            fallbackCopy(text);
        }
    } catch (err) {
        console.error("Copy error:", err);
        showToast("Copy failed!");
    }
}

function fallbackCopy(text) {
    const textarea = document.createElement("textarea");
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    textarea.setSelectionRange(0, 99999);
    const successful = document.execCommand('copy');
    document.body.removeChild(textarea);
    if (successful) {
        showToast("Copied to clipboard!");
    } else {
        showToast("Copy failed!");
    }
}

// Toast helper (ku dar haddii aadan hore u haysan)
function showToast(message) {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: #333; color: #fff; padding: 10px 20px; border-radius: 8px;
      font-size: 14px; z-index: 10001; opacity: 0; transition: opacity 0.3s;
    `;
    document.body.appendChild(toast);
    setTimeout(() => { toast.style.opacity = "1"; }, 50);
    setTimeout(() => { toast.style.opacity = "0"; }, 2000);
    setTimeout(() => { toast.remove(); }, 2500);
     }
    

      // Tab switching event listeners
      document.getElementById('overviewTab').addEventListener('click', () => switchTab('overview'));
      document.getElementById('orderbookTab').addEventListener('click', () => switchTab('orderbook'));
      document.getElementById('lastTradesTab').addEventListener('click', () => switchTab('lastTrades'));

      // Timeframe button event listeners
      document.querySelectorAll('.timeframe-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // Update chart with selected timeframe
          const timeframe = this.getAttribute('data-timeframe');
          createRealPriceChart(timeframe);
        });
      });

      // Trade button functionality
      document.getElementById('btnBuy').addEventListener('click', function() {
        console.log('Buy button clicked');
        openTradeModal('buy');
      });

      document.getElementById('btnSell').addEventListener('click', function() {
        console.log('Sell button clicked');
        openTradeModal('sell');
      });

      // Modal price/amount calculation
      document.getElementById('modalPrice').addEventListener('input', calculateTotal);
      document.getElementById('modalAmount').addEventListener('input', calculateTotal);

      // Percentage buttons in modal
      document.querySelectorAll('.rowBtns button').forEach(btn => {
        btn.addEventListener('click', function() {
          const percentage = parseInt(this.getAttribute('data-fill'));
          const availText = document.getElementById('availBalance').textContent;
          const availAmount = parseFloat(availText.split(' ')[0]);
          const price = parseFloat(document.getElementById('modalPrice').value) || 0;
          
          if (currentTradeMode === 'buy' && price > 0) {
            const xlmToSpend = (availAmount * percentage) / 100;
            const laamAmount = xlmToSpend / price;
            document.getElementById('modalAmount').value = laamAmount.toFixed(7);
          } else if (currentTradeMode === 'sell') {
            const laamToSell = (availAmount * percentage) / 100;
            document.getElementById('modalAmount').value = laamToSell.toFixed(7);
          }
          
          calculateTotal();
        });
      });

      // Modal execute trade button
      document.getElementById('modalBuyBtn').addEventListener('click', async function() {
        const price = parseFloat(document.getElementById('modalPrice').value);
        const amount = parseFloat(document.getElementById('modalAmount').value);
        
        if (!price || !amount) {
          showError('Please enter both price and amount.');
          return;
        }
        
        if (!currentKeypair) {
          showError('Wallet not loaded.');
          return;
        }
        
        const availText = document.getElementById('availBalance').textContent;
        const availAmount = parseFloat(availText.split(' ')[0]);
        
        if (currentTradeMode === 'buy') {
          const totalCost = price * amount;
          if (totalCost > availAmount) {
            showError('Insufficient XLM balance for this trade.');
            return;
          }
        } else {
          if (amount > availAmount) {
            showError('Insufficient Laam balance for this trade.');
            return;
          }
        }
        
        this.disabled = true;
        this.textContent = currentTradeMode === 'buy' ? 'Placing Buy Order...' : 'Placing Sell Order...';
        
        try {
          const result = await createOffer(currentTradeMode, amount, price);
          
          showSuccess(`${currentTradeMode === 'buy' ? 'Buy' : 'Sell'} order placed successfully!\n\nTransaction Hash: ${result.hash}\n\nAmount: ${amount} Laam\nPrice: ${price} XLM per Laam\nTotal: ${(price * amount).toFixed(7)} XLM`);
          
          closeTradeModal();
          
          await updateBalanceDisplay();
          if (currentTab === 'orderbook') {
            await fetchOrderbook();
          }
          
        } catch (error) {
          console.error('Trade error:', error);
          showError('Failed to execute trade: ' + error.message);
        } finally {
          this.disabled = false;
          this.textContent = currentTradeMode === 'buy' ? 'Buy Laam' : 'Sell Laam';
        }
      });
      
      // Confirm edit button
      document.getElementById('confirmEditBtn').addEventListener('click', async function() {
        const newAmount = document.getElementById('editAmount').value;
        const newPrice = document.getElementById('editPrice').value;
        
        if (!newAmount || !newPrice) {
          showError('Please enter both amount and price');
          return;
        }
        
        this.disabled = true;
        this.textContent = 'Updating...';
        
        try {
          await editOffer(currentOfferId, newAmount, newPrice);
          showSuccess('Order updated successfully!');
          closeEditModal();
          await openMyOrdersModal();
        } catch (error) {
          showError('Failed to update order: ' + error.message);
        } finally {
          this.disabled = false;
          this.textContent = 'Update Order';
        }
      });
      
      console.log('All event listeners attached successfully');
    });

    // Auto-refresh balance, price, and current tab data every 30 seconds
    setInterval(async () => {
      if (currentKeypair && !document.getElementById('loggedInView').classList.contains('hidden')) {
        await fetchXLMPrice();
        await updateBalanceDisplay();
        
        if (currentTab === 'orderbook') {
          await fetchOrderbook();
        } else if (currentTab === 'lastTrades') {
          await fetchTrades();
        } else if (currentTab === 'overview') {
          updateOverview();
        }
      }
    }, 30000);

    // Fetch real-time Laam/XLM price from Stellar DEX
    async function fetchLaamPrice() {
      try {
        const orderbookUrl = `https://horizon.stellar.org/order_book?selling_asset_type=credit_alphanum4&selling_asset_code=${LAAM_TOKEN.code}&selling_asset_issuer=${LAAM_TOKEN.issuer}&buying_asset_type=native&limit=1`;
        
        const response = await fetch(orderbookUrl);
        const data = await response.json();
        
        if (data.bids && data.bids.length > 0 && data.asks && data.asks.length > 0) {
          const bestBid = parseFloat(data.bids[0].price);
          const bestAsk = parseFloat(data.asks[0].price);
          const currentPrice = (bestBid + bestAsk) / 2;
          
          return {
            price: currentPrice,
            bid: bestBid,
            ask: bestAsk
          };
        }
        
        return { price: 0.06, bid: 0.06, ask: 0.06 }; // Fallback to default price
      } catch (error) {
        console.error('Error fetching Laam price:', error);
        return { price: 0.06, bid: 0.06, ask: 0.06 }; // Fallback to default price
      }
    }

    // Fetch trade history for Laam/XLM
    async function fetchTradeHistory(limit = 100) {
      try {
        const tradesUrl = `https://horizon.stellar.org/trades?base_asset_type=credit_alphanum4&base_asset_code=${LAAM_TOKEN.code}&base_asset_issuer=${LAAM_TOKEN.issuer}&counter_asset_type=native&limit=${limit}&order=desc`;
        
        const response = await fetch(tradesUrl);
        const data = await response.json();
        
        if (data._embedded && data._embedded.records) {
          return data._embedded.records;
        }
        
        return [];
      } catch (error) {
        console.error('Error fetching trade history:', error);
        return [];
      }
    }

    // Calculate 24h stats from trade history
    function calculate24hStats(trades) {
      const now = new Date();
      const twentyFourHoursAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));
      
      const recentTrades = trades.filter(trade => 
        new Date(trade.ledger_close_time) >= twentyFourHoursAgo
      );
      
      if (recentTrades.length === 0) {
        return {
          volume: 0,
          high: 0,
          low: 0,
          change: 0,
          changePercent: 0
        };
      }
      
      let volume = 0;
      let high = 0;
      let low = Infinity;
      let prices = [];
      
      recentTrades.forEach(trade => {
        const price = parseFloat(trade.price.n / trade.price.d);
        const amount = parseFloat(trade.base_amount);
        
        volume += amount;
        
        if (price > high) high = price;
        if (price < low) low = price;
        
        prices.push({
          price: price,
          time: new Date(trade.ledger_close_time)
        });
      });
      
      // Sort prices by time to get first and last price
      prices.sort((a, b) => a.time - b.time);
      
      const firstPrice = prices.length > 0 ? prices[0].price : 0;
      const lastPrice = prices.length > 0 ? prices[prices.length - 1].price : 0;
      const change = lastPrice - firstPrice;
      const changePercent = firstPrice > 0 ? (change / firstPrice) * 100 : 0;
      
      return {
        volume: volume,
        high: high,
        low: low === Infinity ? 0 : low,
        change: change,
        changePercent: changePercent
      };
    }

    // Create price chart with real data
    async function createRealPriceChart(timeframe = '1D') {
      const trades = await fetchTradeHistory(500); // Get more trades for different timeframes
      const ctx = document.getElementById('priceChart').getContext('2d');
      
      // Filter trades based on timeframe
      const now = new Date();
      let filteredTrades = [];
      let timeLabels = [];
      
      switch(timeframe) {
        case '1D':
          const oneDayAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));
          filteredTrades = trades.filter(trade => 
            new Date(trade.ledger_close_time) >= oneDayAgo
          );
          timeLabels = filteredTrades.map(trade => 
            new Date(trade.ledger_close_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
          );
          break;
          
        case '1W':
          const oneWeekAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
          filteredTrades = trades.filter(trade => 
            new Date(trade.ledger_close_time) >= oneWeekAgo
          );
          // Group by day and calculate average price per day
          const dailyPrices = {};
          filteredTrades.forEach(trade => {
            const date = new Date(trade.ledger_close_time).toLocaleDateString();
            const price = parseFloat(trade.price.n / trade.price.d);
            
            if (!dailyPrices[date]) {
              dailyPrices[date] = { total: 0, count: 0 };
            }
            
            dailyPrices[date].total += price;
            dailyPrices[date].count += 1;
          });
          
          filteredTrades = Object.keys(dailyPrices).map(date => ({
            price: dailyPrices[date].total / dailyPrices[date].count,
            date: date
          }));
          
          timeLabels = Object.keys(dailyPrices);
          break;
          
        case '1M':
          const oneMonthAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
          filteredTrades = trades.filter(trade => 
            new Date(trade.ledger_close_time) >= oneMonthAgo
          );
          // Group by week and calculate average price per week
          const weeklyPrices = {};
          filteredTrades.forEach(trade => {
            const date = new Date(trade.ledger_close_time);
            const week = `Week ${Math.ceil(date.getDate() / 7)}`;
            const price = parseFloat(trade.price.n / trade.price.d);
            
            if (!weeklyPrices[week]) {
              weeklyPrices[week] = { total: 0, count: 0 };
            }
            
            weeklyPrices[week].total += price;
            weeklyPrices[week].count += 1;
          });
          
          filteredTrades = Object.keys(weeklyPrices).map(week => ({
            price: weeklyPrices[week].total / weeklyPrices[week].count,
            week: week
          }));
          
          timeLabels = Object.keys(weeklyPrices);
          break;
          
        case 'ALL':
        default:
          filteredTrades = trades;
          timeLabels = filteredTrades.map(trade => 
            new Date(trade.ledger_close_time).toLocaleDateString()
          );
          break;
      }
      
      const prices = filteredTrades.map(trade => 
        typeof trade.price === 'number' ? trade.price : parseFloat(trade.price.n / trade.price.d)
      );
      
      // Destroy existing chart if it exists
      if (priceChart) {
        priceChart.destroy();
      }
      
      // If we don't have enough data, show the Stellar.expert iframe
      if (prices.length < 2) {
        // Hide the canvas
        ctx.canvas.style.display = 'none';
        
        return;
      }
      
      priceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: timeLabels,
          datasets: [{
            label: 'LAAM/XLM Price',
            data: prices,
            borderColor: '#1976d2',
            backgroundColor: 'rgba(25, 118, 210, 0.1)',
            borderWidth: 2,
            pointRadius: 2,
            pointBackgroundColor: '#1976d2',
            pointBorderColor: '#fff',
            pointHoverRadius: 4,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.7)',
              titleFont: {
                size: 14
              },
              bodyFont: {
                size: 13
              },
              callbacks: {
                label: function(context) {
                  return `Price: ${context.parsed.y.toFixed(7)} XLM`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              ticks: {
                maxRotation: 0,
                autoSkip: true,
                maxTicksLimit: 6
              }
            },
            y: {
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                callback: function(value) {
                  return value.toFixed(6) + ' XLM';
                }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index',
          }
        }
      });
    }

    // Update overview tab with real data
    async function updateOverview() {
      try {
        // Fetch current price
        const priceData = await fetchLaamPrice();
        const currentPrice = priceData.price;
        
        // Fetch trade history for stats
        const trades = await fetchTradeHistory(200);
        const stats = calculate24hStats(trades);
        
        // Update price display
        document.getElementById('overviewLaamPriceXLM').textContent = currentPrice.toFixed(7);
        
        // Update price change
        const priceChangeElement = document.getElementById('priceChange');
        const changeSign = stats.change >= 0 ? '+' : '';
        priceChangeElement.textContent = `${changeSign}${stats.change.toFixed(7)} (${changeSign}${stats.changePercent.toFixed(2)}%)`;
        priceChangeElement.className = stats.change >= 0 ? 'price-change positive' : 'price-change negative';
        
        // Update market stats
        document.getElementById('volume24h').textContent = `${stats.volume.toFixed(2)} Laam`;
        document.getElementById('high24h').textContent = `${stats.high.toFixed(7)} XLM`;
        document.getElementById('low24h').textContent = `${stats.low.toFixed(7)} XLM`;
        
        // Calculate market cap (current price * max supply)
        const marketCap = currentPrice * LAAM_TOKEN.maxSupply;
        document.getElementById('marketCap').textContent = `${marketCap.toFixed(0)} XLM`;
        
        // Create or update the price chart
        const activeTimeframe = document.querySelector('.timeframe-btn.active').getAttribute('data-timeframe');
        await createRealPriceChart(activeTimeframe);
        
      } catch (error) {
        console.error('Error updating overview:', error);
        
        // Fallback values in case of error
        document.getElementById('overviewLaamPriceXLM').textContent = '0.060000';
        document.getElementById('priceChange').textContent = 'Error loading data';
        document.getElementById('volume24h').textContent = '0 Laam';
        document.getElementById('high24h').textContent = '0.000000 XLM';
        document.getElementById('low24h').textContent = '0.000000 XLM';
        document.getElementById('marketCap').textContent = '0 XLM';
        
        createPriceChart(); // Fallback to sample chart
      }
      }
      function openSendWizard(asset) {
  console.log("Open send wizard for:", asset);
  // halkan waxaad ku xiri kartaa wizard-kii send
      }
  function showStep(step){
    for(let i=1;i<=4;i++) document.getElementById("step"+i).style.display="none";
    if(step>=1) document.getElementById("step"+step).style.display="block";
    if(step===4){
      document.getElementById("confirmAsset").textContent = document.getElementById("sendAsset").value;
      document.getElementById("confirmAmount").textContent = document.getElementById("sendAmount").value;
      document.getElementById("confirmDest").textContent = document.getElementById("sendDest").value;
      document.getElementById("confirmMemo").textContent = document.getElementById("sendMemo").value || "‚Äî";
    }
  }
  function nextStep(step){ showStep(step); }
  function backStep(step){
    if(step<1){
      document.getElementById("sendWizard").style.display="none";
      document.getElementById("wizardOverlay").style.display="none";
    } else showStep(step);
  }

  // Open wizard
  document.getElementById("btnSend").onclick = function(){
    document.getElementById("sendWizard").style.display="block";
    document.getElementById("wizardOverlay").style.display="block";
    showStep(1);
  }
  // Close wizard
  document.getElementById("wizardOverlay").onclick = closeWizard;
  document.getElementById("wizardClose").onclick = closeWizard;

  function closeWizard(){
    document.getElementById("sendWizard").style.display="none";
  }

  // Send Transaction
  async function sendTransaction(){
    const asset = document.getElementById("sendAsset").value;
    const amount = document.getElementById("sendAmount").value;
    const destination = document.getElementById("sendDest").value;
    const memo = document.getElementById("sendMemo").value;

    const btn = document.getElementById("confirmSendBtn");
    btn.textContent = "Sending...";
    btn.disabled = true;

    try {
      const account = await server.loadAccount(currentKeypair.publicKey());

      let operation;
      if(asset === "XLM"){
        operation = StellarSdk.Operation.payment({
          destination, asset: StellarSdk.Asset.native(), amount
        });
      } else if(asset === "LAAM"){
        operation = StellarSdk.Operation.payment({
          destination, asset: LAAM_ASSET, amount
        });
      } else if(asset === "USDC"){
        operation = StellarSdk.Operation.payment({
          destination, asset: USDC_ASSET, amount
        });
      }

      const txBuilder = new StellarSdk.TransactionBuilder(account, {
        fee: StellarSdk.BASE_FEE,
        networkPassphrase: StellarSdk.Networks.PUBLIC
      });

      if(memo){ txBuilder.addMemo(StellarSdk.Memo.text(memo)); }

      const transaction = txBuilder.addOperation(operation).setTimeout(180).build();
      transaction.sign(currentKeypair);

      const result = await server.submitTransaction(transaction);

     showSuccess('Transaction sent successfully!');
      closeWizard();

    } catch(err){
      console.error("Send error:", err);
      alert("‚ùå Failed: " + err.message);
    } finally {
      btn.textContent = "Send Now";
      btn.disabled = false;
    }
  }

function swapTradeAssets() {
  // Hel labada asset box
  const assetBoxes = document.querySelectorAll(".trade-asset-selector .asset-box");

  if (assetBoxes.length === 2) {
    const firstBox = assetBoxes[0];
    const secondBox = assetBoxes[1];

    // Ku keydi copy of firstBox HTML
    const tempHTML = firstBox.innerHTML;

    // Swap contents
    firstBox.innerHTML = secondBox.innerHTML;
    secondBox.innerHTML = tempHTML;
  }
}

function showStep(step){
  for(let i=1;i<=6;i++){
    const s = document.getElementById("step"+i);
    if(s) s.style.display="none";
  }
  currentStep = step;

  // Update confirmation fields for step 5
  if(step===5){
    document.getElementById("confirmAsset").textContent = document.getElementById("sendAsset").value;
    document.getElementById("confirmAmount").textContent = document.getElementById("sendAmount").value;
    document.getElementById("confirmDest").textContent = document.getElementById("sendDest").value;
    document.getElementById("confirmMemo").textContent = document.getElementById("sendMemo").value || "‚Äî";
  }

  document.getElementById("step"+step).style.display="block";
}

// Next step
function nextStep(step){
  const errorBox = document.getElementById("wizardError");
  errorBox.style.display = "none";

  if(step===2){
    let asset = document.getElementById("sendAsset").value;
    if(!asset){
      errorBox.textContent = "Please select an asset";
      errorBox.style.display = "block";
      return;
    }
  }

  if(step===3){
    let amount = document.getElementById("sendAmount").value;
    if(!amount || parseFloat(amount)<=0){
      errorBox.textContent = "Please enter amount";
      errorBox.style.display = "block";
      return;
    }
  }

  if(step===4){
    let dest = document.getElementById("sendDest").value.trim();
    if(!dest){
      errorBox.textContent = "Please enter destination address";
      errorBox.style.display = "block";
      return;
    }
  }

  showStep(step);
}

// Open wizard
document.getElementById("btnSend").onclick = function(){
  document.getElementById("sendWizard").style.display="block";
  document.getElementById("wizardOverlay").style.display="block";
  showStep(1);
}

// Close wizard
document.getElementById("wizardOverlay").onclick = closeWizard;
document.getElementById("wizardClose").onclick = closeWizard;

function closeWizard(){
  document.getElementById("sendWizard").style.display="none";
  document.getElementById("wizardOverlay").style.display="none";
  document.getElementById("wizardError").style.display="none";
}

// Toast notification
function showToast(message, duration = 2000){
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.background = '#1a73e8'; // Blue like buttons
  toast.style.color = '#fff';
  toast.style.padding = '10px 15px';
  toast.style.borderRadius = '12px';
  toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
  toast.style.fontSize = '14px';
  toast.style.opacity = '0';
  toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
  toast.style.transform = 'translateY(-10px)';

  document.getElementById('toastContainer').appendChild(toast);

  requestAnimationFrame(() => {
    toast.style.opacity = '1';
    toast.style.transform = 'translateY(0)';
  });

  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(-10px)';
    toast.addEventListener('transitionend', ()=> toast.remove());
  }, duration);
}

// Copy helper using toast
function copyToClipboard(elementId){
  try {
    const text = document.getElementById(elementId).textContent;

    if(navigator.clipboard && window.isSecureContext){
      navigator.clipboard.writeText(text).then(()=>{
        showToast(`Copied: ${text}`);
      }).catch(err=>{
        fallbackCopy(text);
      });
    } else {
      fallbackCopy(text);
    }

  } catch(err){
    console.error("Copy error:", err);
    showToast("Copy failed!");
  }
}

function fallbackCopy(text){
  const textarea = document.createElement("textarea");
  textarea.value = text;
  document.body.appendChild(textarea);
  textarea.select();
  textarea.setSelectionRange(0, 99999);
  const successful = document.execCommand('copy');
  document.body.removeChild(textarea);
  if(successful){
    showToast(`Copied: ${text}`);
  } else {
    showToast("Copy failed!");
  }
}

// Send Transaction update
async function sendTransaction(){
  const asset = document.getElementById("sendAsset").value;
  const amount = document.getElementById("sendAmount").value;
  const destination = document.getElementById("sendDest").value;
  const memo = document.getElementById("sendMemo").value;

  const btn = document.getElementById("confirmSendBtn");
  btn.textContent = "Sending...";
  btn.disabled = true;

  try {
    const account = await server.loadAccount(currentKeypair.publicKey());

    let operation;
    if(asset === "XLM"){
      operation = StellarSdk.Operation.payment({
        destination, asset: StellarSdk.Asset.native(), amount
      });
    } else if(asset === "LAAM"){
      operation = StellarSdk.Operation.payment({
        destination, asset: LAAM_ASSET, amount
      });
    } else if(asset === "USDC"){
      operation = StellarSdk.Operation.payment({
        destination, asset: USDC_ASSET, amount
      });
    }

    const txBuilder = new StellarSdk.TransactionBuilder(account, {
      fee: StellarSdk.BASE_FEE,
      networkPassphrase: StellarSdk.Networks.PUBLIC
    });

    if(memo){ txBuilder.addMemo(StellarSdk.Memo.text(memo)); }

    const transaction = txBuilder.addOperation(operation).setTimeout(180).build();
    transaction.sign(currentKeypair);

    const result = await server.submitTransaction(transaction);

    // Populate receipt
    document.getElementById("receiptDest").textContent = destination;

    // Txid link to Stellar Expert
    const txLink = `https://stellar.expert/explorer/public/tx/${result.hash}`;
    const receiptHashEl = document.getElementById("receiptHash");
    receiptHashEl.textContent = result.hash;
    receiptHashEl.href = txLink;

    document.getElementById("receiptAmount").textContent = `${amount} ${asset}`;

    const now = new Date();
    const formattedDate = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
    document.getElementById("receiptDate").textContent = formattedDate;

    showStep(6);

  } catch(err){
    console.error("Send error:", err);
    alert("‚ùå Failed: " + err.message);
  } finally {
    btn.textContent = "Send Now";
    btn.disabled = false;
  }
}

    
</script>
</script>
</body>
</html>
